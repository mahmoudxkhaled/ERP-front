<div class="card">
    <div class="flex justify-content-between align-items-center mb-4">
        <h2>{{ (isEdit ? 'systemAdministration.erpModules.moduleForm.titleEdit' : 'systemAdministration.erpModules.moduleForm.titleCreate') | translate }}</h2>
        <p-button [label]="'systemAdministration.erpModules.moduleForm.actions.backToList' | translate" icon="pi pi-arrow-left" class="p-button-secondary" (onClick)="cancel()"
            [disabled]="loading">
        </p-button>
    </div>

    <form *ngIf="form" [formGroup]="form" (ngSubmit)="submit()">
        <div class="flex flex-column gap-3">
            <!-- Function Selection Field -->
            <div class="field p-fluid">
                <label for="functionId">{{ 'systemAdministration.erpModules.moduleForm.fields.function' | translate }} <span class="text-red-500">*</span></label>
                <div class="p-inputgroup">
                    <input id="functionId" type="text" pInputText [value]="getFunctionDisplayText()" readonly
                        [placeholder]="'systemAdministration.erpModules.moduleForm.placeholders.selectFunction' | translate" (click)="openFunctionDialog()" style="cursor: pointer;" />
                    <p-button icon="pi pi-search" (onClick)="openFunctionDialog()"
                        [disabled]="loading || loadingFunctions" class="p-button-secondary">
                    </p-button>
                </div>
                <small class="p-error" *ngIf="submitted && f['functionId'].invalid">
                    {{ functionIdError }}
                </small>
            </div>

            <!-- Code Field -->
            <div class="field p-fluid">
                <label for="code">{{ 'systemAdministration.erpModules.moduleForm.fields.code' | translate }} <span class="text-red-500">*</span></label>
                <input id="code" type="text" pInputText formControlName="code" [maxlength]="10"
                    [placeholder]="'systemAdministration.erpModules.moduleForm.placeholders.code' | translate" />
                <small class="p-error" *ngIf="submitted && f['code'].invalid">
                    {{ codeError }}
                </small>
            </div>

            <!-- Name Field -->
            <div class="field p-fluid">
                <label for="name">{{ 'systemAdministration.erpModules.moduleForm.fields.name' | translate }} <span class="text-red-500">*</span></label>
                <input id="name" type="text" pInputText formControlName="name" [maxlength]="30"
                    [placeholder]="'systemAdministration.erpModules.moduleForm.placeholders.name' | translate" />
                <small class="p-error" *ngIf="submitted && f['name'].invalid">
                    {{ nameError }}
                </small>
            </div>

            <!-- Is Regional Checkbox (only for edit mode) -->
            <div class="field p-fluid" *ngIf="isEdit">
                <p-inputSwitch formControlName="isRegional" id="isRegional"></p-inputSwitch>
                <label for="isRegional" class="ml-2">{{ 'systemAdministration.erpModules.moduleForm.fields.isRegional' | translate }}</label>
                <small class="block text-500 mt-1">{{ 'systemAdministration.erpModules.moduleForm.fields.isRegionalHint' | translate }}</small>
            </div>

            <!-- Default Order Field -->
            <div class="field p-fluid">
                <label for="defaultOrder">{{ 'systemAdministration.erpModules.moduleForm.fields.defaultOrder' | translate }} <span class="text-red-500">*</span></label>
                <input id="defaultOrder" type="number" pInputText formControlName="defaultOrder" [min]="1"
                    [placeholder]="'systemAdministration.erpModules.moduleForm.placeholders.defaultOrder' | translate" />
                <small class="p-error" *ngIf="submitted && f['defaultOrder'].invalid">
                    {{ defaultOrderError }}
                </small>
            </div>

            <!-- URL Field -->
            <div class="field p-fluid">
                <label for="url">{{ 'systemAdministration.erpModules.moduleForm.fields.url' | translate }}</label>
                <input id="url" type="text" pInputText formControlName="url"
                    [placeholder]="'systemAdministration.erpModules.moduleForm.placeholders.url' | translate" />
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-content-end gap-2 mt-4">
            <p-button [label]="'systemAdministration.erpModules.moduleForm.actions.cancel' | translate" icon="pi pi-times" class="p-button-text" (onClick)="cancel()" [disabled]="loading">
            </p-button>
            <p-button [label]="(isEdit ? 'systemAdministration.erpModules.moduleForm.actions.update' : 'systemAdministration.erpModules.moduleForm.actions.create') | translate" icon="pi pi-check" type="submit" [loading]="loading"
                [disabled]="loading || form.invalid">
            </p-button>
        </div>
    </form>
</div>

<!-- Function Selection Dialog -->
<p-dialog [(visible)]="functionDialogVisible" [modal]="true" [style]="{ width: '600px' }" [closable]="true"
    [draggable]="false" [resizable]="false" (onHide)="closeFunctionDialog()">
    <ng-template pTemplate="header">
        <h3>{{ 'systemAdministration.erpModules.moduleForm.functionDialog.title' | translate }}</h3>
    </ng-template>

    <div class="flex flex-column gap-3">
        <!-- Skeleton: same area as function list (max-height 400px, list of rows) -->
        <div *ngIf="loadingFunctions" class="flex flex-column gap-2" style="max-height: 400px; overflow-y: auto;">
            <div *ngFor="let i of [1,2,3,4,5,6,7]" class="p-3 border-round surface-border"
                style="border: 1px solid var(--surface-border);">
                <div class="flex align-items-center justify-content-between">
                    <p-skeleton width="12rem" height="1.25rem"></p-skeleton>
                    <p-skeleton width="4rem" height="1rem"></p-skeleton>
                </div>
            </div>
        </div>

        <div *ngIf="!loadingFunctions" class="flex flex-column gap-2" style="max-height: 400px; overflow-y: auto;">
            <div *ngFor="let functionItem of functions" class="p-3 border-round surface-border cursor-pointer"
                [class.selected-row]="isFunctionSelected(functionItem)" (click)="selectFunction(functionItem)"
                style="border: 1px solid var(--surface-border);">
                <div class="flex align-items-center justify-content-between">
                    <div>
                        <span class="font-semibold text-lg">{{ functionItem.name }}</span>
                        <span class="text-500 ml-2">({{ functionItem.code }})</span>
                    </div>
                    <i *ngIf="isFunctionSelected(functionItem)" class="pi pi-check text-primary"></i>
                </div>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2">
            <p-button [label]="'systemAdministration.erpModules.moduleForm.actions.cancel' | translate" icon="pi pi-times" class="p-button-text" (onClick)="closeFunctionDialog()"
                [disabled]="loadingFunctions">
            </p-button>
            <p-button [label]="'systemAdministration.erpModules.moduleForm.actions.select' | translate" icon="pi pi-check" (onClick)="closeFunctionDialog()"
                [disabled]="loadingFunctions || !selectedFunction">
            </p-button>
        </div>
    </ng-template>
</p-dialog>

<p-toast></p-toast>