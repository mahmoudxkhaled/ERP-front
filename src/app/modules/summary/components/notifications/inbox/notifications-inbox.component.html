<div class="card">
    <div class="flex justify-content-between align-items-center mb-4">
        <h2>Notifications Inbox</h2>
        <div class="flex align-items-center gap-2">
            <div class="flex align-items-center gap-2">
                <label class="block mb-2 font-medium">Unread Only</label>
                <p-inputSwitch [(ngModel)]="unreadOnly" (onChange)="onUnreadOnlyChange()"></p-inputSwitch>
            </div>
            <div class="flex align-items-center gap-2">
                <p-tag [value]="'Unread: ' + getUnreadCount()" severity="warning" *ngIf="getUnreadCount() > 0"></p-tag>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="grid mb-3">

        <div class="col-12 md:col-4 p-fluid">
            <label class="block mb-2 font-medium">Text Filter</label>
            <input type="text" pInputText [(ngModel)]="textFilter" placeholder="Search..." (input)="onFilterChange()" />
        </div>


        <div class="col-12 md:col-4 p-fluid">
            <label class="block mb-2 font-medium">Type Filter</label>
            <p-multiSelect [options]="notificationTypes" [(ngModel)]="selectedTypeIds" optionLabel="title"
                optionValue="type_ID" placeholder="Select Types" (onChange)="onFilterChange()" [showClear]="false"
                [showToggleAll]="false">
            </p-multiSelect>
        </div>
        <div class="col-12 md:col-4 p-fluid">
            <label class="block mb-2 font-medium">Category Filter</label>
            <p-multiSelect [options]="notificationCategories" [(ngModel)]="selectedCategoryIds" optionLabel="Title"
                optionValue="Category_ID" placeholder="Select Categories" (onChange)="onFilterChange()"
                [showClear]="false" [showToggleAll]="false">
            </p-multiSelect>
        </div>

    </div>

    <div style="position: relative;">
        <p-table #notificationsTable [value]="tableValue" [paginator]="false" responsiveLayout="scroll">

            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 50px;">Status</th>
                    <th style="width: 120px;">Type</th>
                    <th style="width: 200px;">Title</th>
                    <th style="width: 400px;">Message</th>
                    <th style="width: 150px;">Date</th>
                    <th style="width: 200px; text-align: start !important;">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-notification>
                <tr [class.unread]="!notification.isRead">
                    <td>
                        <ng-container *ngIf="isLoading$ | async; else normalStatus">
                            <p-skeleton height="1.5rem" width="5rem" borderRadius="4px"></p-skeleton>
                        </ng-container>
                        <ng-template #normalStatus>
                            <p-tag [value]="notification.isRead ? 'Read' : 'Unread'"
                                [severity]="notification.isRead ? 'success' : 'warning'">
                            </p-tag>
                        </ng-template>
                    </td>
                    <td>
                        <ng-container *ngIf="isLoading$ | async; else normalType">
                            <p-skeleton height="1.5rem" width="5rem"></p-skeleton>
                        </ng-container>
                        <ng-template #normalType>
                            <span class="text-600">{{ getTypeName(notification.typeId) }}</span>
                        </ng-template>
                    </td>
                    <td>
                        <ng-container *ngIf="isLoading$ | async; else normalTitle">
                            <p-skeleton height="1rem" width="10rem"></p-skeleton>
                        </ng-container>
                        <ng-template #normalTitle>
                            <span class="font-semibold">{{ notification.title }}</span>
                        </ng-template>
                    </td>
                    <td>
                        <ng-container *ngIf="isLoading$ | async; else normalMessage">
                            <p-skeleton height="3rem" width="100%" class="line-height-3"></p-skeleton>
                        </ng-container>
                        <ng-template #normalMessage>
                            <span class="text-600 line-height-3">{{ notification.message }}</span>
                        </ng-template>
                    </td>
                    <td>
                        <ng-container *ngIf="isLoading$ | async; else normalDate">
                            <p-skeleton height="1.5rem" width="6rem"></p-skeleton>
                        </ng-container>
                        <ng-template #normalDate>
                            <span>{{ notification.createdAt | date: 'short' }}</span>
                        </ng-template>
                    </td>
                    <td class="text-start">
                        <ng-container *ngIf="isLoading$ | async; else normalActions">
                            <p-skeleton height="2rem" width="8rem"></p-skeleton>
                        </ng-container>
                        <ng-template #normalActions>
                            <div class="flex gap-2">
                                <p-button *ngIf="!notification.isRead" icon="pi pi-check" pTooltip="Mark as Read"
                                    class="p-button-sm p-button-text" (onClick)="markAsRead(notification)">
                                </p-button>
                                <p-button *ngIf="notification.isRead" icon="pi pi-eye-slash" pTooltip="Mark as Unread"
                                    class="p-button-sm p-button-text" (onClick)="markAsUnread(notification)">
                                </p-button>
                                <p-button icon="pi pi-trash" pTooltip="Delete"
                                    class="p-button-sm p-button-text p-button-danger"
                                    (onClick)="deleteNotification(notification)">
                                </p-button>
                            </div>
                        </ng-template>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center">No notifications found</td>
                </tr>
            </ng-template>
        </p-table>

        <div class="flex justify-content-center mt-3" *ngIf="!tableLoadingSpinner && notifications.length < totalCount">
            <p-button label="Load More" icon="pi pi-arrow-down" (onClick)="loadMore()"
                [loading]="!!(isLoading$ | async)">
            </p-button>
        </div>
    </div>
</div>

<p-toast></p-toast>