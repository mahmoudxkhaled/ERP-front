<p-dialog [(visible)]="visible" [modal]="true" [style]="{ width: '900px' }" [closable]="true"
    [draggable]="false" [resizable]="false" (onHide)="closeDialog()">
    <ng-template pTemplate="header">
        <h3>Send Notification</h3>
    </ng-template>

    <div class="card" style="box-shadow: none;">

    <div *ngIf="loading" class="flex justify-content-center align-items-center" style="min-height: 200px;">
        <p-progressSpinner></p-progressSpinner>
    </div>

    <div *ngIf="!loading && notification">
        <p-panel header="Notification Details" class="mb-4">
            <div class="grid">
                <div class="col-12">
                    <div class="field">
                        <label class="font-semibold">Title</label>
                        <p>{{ notification.title }}</p>
                    </div>
                </div>
                <div class="col-12">
                    <div class="field">
                        <label class="font-semibold">Message</label>
                        <p>{{ notification.message }}</p>
                    </div>
                </div>
            </div>
        </p-panel>

        <p-panel header="Select Target">
            <div class="grid mb-3">
                <div class="col-12">
                    <label class="block mb-2 font-medium">Send To</label>
                    <div class="flex gap-2">
                        <p-button [label]="'Accounts'" [class]="selectedTargetType === 'accounts' ? 'p-button-primary' : 'p-button-secondary'" 
                            (onClick)="selectedTargetType = 'accounts'; onTargetTypeChange()"></p-button>
                        <p-button [label]="'Groups'" [class]="selectedTargetType === 'groups' ? 'p-button-primary' : 'p-button-secondary'" 
                            (onClick)="selectedTargetType = 'groups'; onTargetTypeChange()"></p-button>
                        <p-button [label]="'Roles'" [class]="selectedTargetType === 'roles' ? 'p-button-primary' : 'p-button-secondary'" 
                            (onClick)="selectedTargetType = 'roles'; onTargetTypeChange()"></p-button>
                        <p-button [label]="'Entities'" [class]="selectedTargetType === 'entities' ? 'p-button-primary' : 'p-button-secondary'" 
                            (onClick)="selectedTargetType = 'entities'; onTargetTypeChange()"></p-button>
                        <p-button [label]="'All'" [class]="selectedTargetType === 'all' ? 'p-button-primary' : 'p-button-secondary'" 
                            [disabled]="!canSendToAll()" (onClick)="selectedTargetType = 'all'; onTargetTypeChange()"></p-button>
                    </div>
                </div>
            </div>

            <!-- Accounts Selection -->
            <div *ngIf="selectedTargetType === 'accounts'" class="mt-3">
                <label class="block mb-2 font-medium">Select Accounts</label>
                <p-table [value]="availableAccounts" selectionMode="multiple" [(selection)]="selectedAccountIds"
                    [paginator]="true" [rows]="10" [loading]="loading">
                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 50px;">
                                <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                            </th>
                            <th>Account ID</th>
                            <th>Email</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-account>
                        <tr>
                            <td>
                                <p-tableCheckbox [value]="account"></p-tableCheckbox>
                            </td>
                            <td>{{ account.Account_ID }}</td>
                            <td>{{ account.Email }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>

            <!-- Groups Selection -->
            <div *ngIf="selectedTargetType === 'groups'" class="mt-3">
                <label class="block mb-2 font-medium">Select Groups (Personal Groups Only)</label>
                <p-table [value]="availableGroups" selectionMode="multiple" [(selection)]="selectedGroupIds"
                    [paginator]="true" [rows]="10" [loading]="loading">
                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 50px;">
                                <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                            </th>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Description</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-group>
                        <tr>
                            <td>
                                <p-tableCheckbox [value]="group"></p-tableCheckbox>
                            </td>
                            <td>{{ group.id }}</td>
                            <td>{{ group.title }}</td>
                            <td>{{ group.description }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>

            <!-- Roles Selection -->
            <div *ngIf="selectedTargetType === 'roles'" class="mt-3">
                <label class="block mb-2 font-medium">Select Roles</label>
                <p>Roles selection will be implemented based on available services.</p>
            </div>

            <!-- Entities Selection -->
            <div *ngIf="selectedTargetType === 'entities'" class="mt-3">
                <label class="block mb-2 font-medium">Select Entities</label>
                <p>Entities selection will be implemented based on available services.</p>
            </div>

            <!-- All -->
            <div *ngIf="selectedTargetType === 'all'" class="mt-3">
                <p class="text-orange-500">This will send the notification to all system users.</p>
            </div>
        </p-panel>
    </div>

    <div *ngIf="!loading && !notification" class="text-center p-4">
        <p class="text-600">No notification selected. Please select a notification first.</p>
    </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" class="p-button-secondary" (onClick)="closeDialog()"
            [disabled]="sending">
        </p-button>
        <p-button label="Send" icon="pi pi-send" (onClick)="send()" [loading]="sending" [disabled]="sending || !notification">
        </p-button>
    </ng-template>
</p-dialog>

<p-toast></p-toast>
