<div class="p-4 card">
    <p-toast></p-toast>

    <!-- Page Header -->
    <div class="flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-3xl font-bold mb-2">{{ 'dashboard.profile' | translate }}{{ 'profile.edit.titleSuffix' | translate }}</h1>
            <p class="text-gray-600 m-0">{{ 'profile.description' | translate }}</p>
        </div>
        <p-button [label]="'profile.edit.backToOverview' | translate" icon="pi pi-arrow-left" (onClick)="navigateBack()"></p-button>
    </div>

    <!-- Profile Form -->
    <form [formGroup]="profileForm" (ngSubmit)="saveProfileInfo()" *ngIf="profileForm">
        <div class="grid mt-4">

            <!-- Profile Picture Panel -->
            <div class="col-12 mt-4">
                <p-panel [header]="'profile.edit.profilePicture' | translate" class="h-full">
                    <div *ngIf="loadingProfilePicture" class="flex justify-content-center align-items-center p-4">
                        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                    </div>
                    <div *ngIf="!loadingProfilePicture" class="grid">
                        <div class="col-12 md:col-4">
                            <div class="flex flex-column align-items-center gap-3">
                                <p-avatar [image]="profilePictureUrl" [icon]="!hasProfilePicture ? 'pi pi-user' : ''"
                                    size="xlarge" shape="circle" styleClass="border-3 border-white shadow-4"
                                    [style]="{'width': '150px', 'height': '150px'}">
                                </p-avatar>
                                <p class="text-sm text-600 m-0">{{ 'profile.edit.currentProfilePicture' | translate }}</p>
                            </div>
                        </div>
                        <div class="col-12 md:col-8">
                            <div class="flex flex-column gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-image mr-2 text-blue-500"></i>
                                        {{ 'profile.edit.uploadNewPicture' | translate }}
                                    </label>
                                    <p-fileUpload mode="basic" name="profilePicture" accept="image/*"
                                        (onSelect)="uploadProfilePicture($event)" [maxFileSize]="2097152"
                                        [chooseLabel]="'profile.edit.chooseImage' | translate" [disabled]="uploadingPicture">
                                    </p-fileUpload>
                                    <small class="text-600">{{ 'profile.edit.allowedFormats' | translate }}</small>
                                </div>
                                <div *ngIf="hasProfilePicture">
                                    <p-button [label]="'profile.edit.removePicture' | translate" icon="pi pi-trash" severity="danger"
                                        (onClick)="removeProfilePicture()" [disabled]="uploadingPicture">
                                        <ng-container *ngIf="uploadingPicture">
                                            <span class="indicator-progress" [style.display]="'block'">
                                                {{ 'profile.edit.pleaseWait' | translate }}
                                                <i class="pi pi-spin pi-spinner" style="font-size: 1rem"></i>
                                            </span>
                                        </ng-container>
                                    </p-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </p-panel>
            </div>

            <!-- Personal Information Panel -->
            <div class="col-12">
                <p-panel [header]="'profile.personalInfo' | translate" class="h-full">
                    <div class="grid">
                        <!-- Prefix -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-user mr-2 text-blue-500"></i>
                                    {{ 'profile.fields.prefix' | translate }}
                                </label>
                                <input pInputText formControlName="Prefix"
                                    [placeholder]="'profile.placeholders.prefix' | translate" class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('Prefix')?.invalid && profileForm.get('Prefix')?.touched}">
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('Prefix')?.invalid && profileForm.get('Prefix')?.touched">
                                    {{ getPrefixError() }}
                                </small>
                            </div>
                        </div>

                        <!-- First Name -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-user mr-2 text-blue-500"></i>
                                    {{ 'profile.fields.firstName' | translate }}
                                    <span class="text-red-500">*</span>
                                </label>
                                <input pInputText formControlName="First_Name"
                                    [placeholder]="'profile.placeholders.firstName' | translate"
                                    class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('First_Name')?.invalid && profileForm.get('First_Name')?.touched}">
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('First_Name')?.invalid && profileForm.get('First_Name')?.touched">
                                    {{ getFirstNameError() }}
                                </small>
                            </div>
                        </div>

                        <!-- Middle Name -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-user mr-2 text-blue-500"></i>
                                    {{ 'profile.fields.middleName' | translate }}
                                </label>
                                <input pInputText formControlName="Middle_Name"
                                    [placeholder]="'profile.placeholders.middleName' | translate"
                                    class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('Middle_Name')?.invalid && profileForm.get('Middle_Name')?.touched}">
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('Middle_Name')?.invalid && profileForm.get('Middle_Name')?.touched">
                                    {{ getMiddleNameError() }}
                                </small>
                            </div>
                        </div>

                        <!-- Last Name -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-user mr-2 text-blue-500"></i>
                                    {{ 'profile.fields.lastName' | translate }}
                                    <span class="text-red-500">*</span>
                                </label>
                                <input pInputText formControlName="Last_Name"
                                    [placeholder]="'profile.placeholders.lastName' | translate" class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('Last_Name')?.invalid && profileForm.get('Last_Name')?.touched}">
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('Last_Name')?.invalid && profileForm.get('Last_Name')?.touched">
                                    {{ getLastNameError() }}
                                </small>
                            </div>
                        </div>

                        <!-- Gender -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-users mr-2 text-blue-500"></i>
                                    {{ 'profile.fields.gender' | translate }}
                                </label>
                                <p-dropdown [options]="genderOptions" formControlName="Gender" optionLabel="label"
                                    optionValue="value"
                                    [placeholder]="'profile.placeholders.selectGender' | translate"
                                    class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('Gender')?.invalid && profileForm.get('Gender')?.touched}">
                                </p-dropdown>
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('Gender')?.invalid && profileForm.get('Gender')?.touched">
                                    {{ 'profile.edit.genderRequired' | translate }}
                                </small>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="flex justify-content-end gap-3 my-1">
                                <p-button (onClick)="saveProfileInfo()" [disabled]="saving || !!(isLoading$ | async)">
                                    <ng-container *ngIf="saving || (isLoading$ | async)">
                                        <span class="indicator-progress" [style.display]="'block'">
                                            {{ 'profile.edit.pleaseWait' | translate }}
                                            <i class="pi pi-spin pi-spinner" style="font-size: 1rem"></i>
                                        </span>
                                    </ng-container>
                                    <ng-container *ngIf="(isLoading$ | async) === false && !saving">
                                        <span>{{ 'profile.actions.save' | translate }}</span>
                                    </ng-container>
                                </p-button>
                            </div>
                        </div>
                    </div>
                </p-panel>
            </div>

            <!-- Contact Information Panel -->
            <div class="col-12 mt-4">
                <p-panel [header]="'profile.edit.contactInformation' | translate" class="h-full">
                    <div *ngIf="loadingContactInfo" class="flex justify-content-center align-items-center p-4">
                        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                    </div>
                    <form [formGroup]="contactInfoForm" (ngSubmit)="saveContactInfo()"
                        *ngIf="!loadingContactInfo && contactInfoForm">
                        <div class="grid">
                            <!-- Address -->
                            <div class="col-12">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-map-marker mr-2 text-blue-500"></i>
                                        {{ 'profile.edit.address' | translate }}
                                    </label>
                                    <textarea pInputTextarea formControlName="address" rows="3"
                                        [placeholder]="'profile.edit.enterAddress' | translate" class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('address')?.invalid && contactInfoForm.get('address')?.touched}"></textarea>
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('address')?.invalid && contactInfoForm.get('address')?.touched">
                                        {{ getAddressError() }}
                                    </small>
                                </div>
                            </div>

                            <!-- Phone Numbers -->
                            <div class="col-12">
                                <div class="flex justify-content-between align-items-center mb-2">
                                    <label class="block text-sm font-medium">
                                        {{ 'profile.edit.phoneNumbers' | translate }} <span class="text-red-500">*</span>
                                    </label>
                                    <p-button [label]="'profile.edit.addPhone' | translate" icon="pi pi-plus" size="small"
                                        (onClick)="addPhoneNumber()" type="button"></p-button>
                                </div>
                                <div formArrayName="phoneNumbers" class="flex flex-column gap-2">
                                    <div *ngFor="let phoneGroup of phoneNumbersFormArray.controls; let i = index"
                                        [formGroupName]="i" class="flex flex-column gap-1">
                                        <div class="flex align-items-center gap-2">
                                            <input type="text" pInputText formControlName="number"
                                                [placeholder]="'profile.edit.enterPhoneNumber' | translate" class="flex-1"
                                                [ngClass]="{'ng-invalid ng-dirty': phoneGroup.get('number')?.invalid && phoneGroup.get('number')?.touched}" />
                                            <button pButton pRipple type="button" icon="pi pi-times"
                                                class="p-button-rounded p-button-danger p-button-text"
                                                (click)="removePhoneNumber(i)" *ngIf="phoneNumbersFormArray.length > 1">
                                            </button>
                                        </div>
                                        <small class="p-error block mt-1"
                                            *ngIf="phoneGroup.get('number')?.invalid && phoneGroup.get('number')?.touched">
                                            {{ getPhoneNumberError(i) }}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Social Media Links -->
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-linkedin mr-2 text-blue-500"></i>
                                        {{ 'profile.edit.linkedinPage' | translate }}
                                    </label>
                                    <input type="url" pInputText formControlName="linkedinPage"
                                        [placeholder]="'profile.edit.linkedinPlaceholder' | translate" class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('linkedinPage')?.invalid && contactInfoForm.get('linkedinPage')?.touched}">
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('linkedinPage')?.invalid && contactInfoForm.get('linkedinPage')?.touched">
                                        {{ 'profile.edit.invalidUrl' | translate }}
                                    </small>
                                </div>
                            </div>

                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-facebook mr-2 text-blue-500"></i>
                                        {{ 'profile.edit.facebookPage' | translate }}
                                    </label>
                                    <input type="url" pInputText formControlName="facebookPage"
                                        [placeholder]="'profile.edit.facebookPlaceholder' | translate" class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('facebookPage')?.invalid && contactInfoForm.get('facebookPage')?.touched}">
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('facebookPage')?.invalid && contactInfoForm.get('facebookPage')?.touched">
                                        {{ 'profile.edit.invalidUrl' | translate }}
                                    </small>
                                </div>
                            </div>

                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-instagram mr-2 text-blue-500"></i>
                                        {{ 'profile.edit.instagramPage' | translate }}
                                    </label>
                                    <input type="url" pInputText formControlName="instagramPage"
                                        [placeholder]="'profile.edit.instagramPlaceholder' | translate" class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('instagramPage')?.invalid && contactInfoForm.get('instagramPage')?.touched}">
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('instagramPage')?.invalid && contactInfoForm.get('instagramPage')?.touched">
                                        {{ 'profile.edit.invalidUrl' | translate }}
                                    </small>
                                </div>
                            </div>

                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-twitter mr-2 text-blue-500"></i>
                                        {{ 'profile.edit.twitterPage' | translate }}
                                    </label>
                                    <input type="url" pInputText formControlName="twitterPage"
                                        [placeholder]="'profile.edit.twitterPlaceholder' | translate" class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('twitterPage')?.invalid && contactInfoForm.get('twitterPage')?.touched}">
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('twitterPage')?.invalid && contactInfoForm.get('twitterPage')?.touched">
                                        {{ 'profile.edit.invalidUrl' | translate }}
                                    </small>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="flex justify-content-end gap-3 my-1">
                                    <p-button (onClick)="saveContactInfo()"
                                        [disabled]="savingContactInfo || !!(isLoading$ | async)">
                                        <ng-container *ngIf="savingContactInfo || (isLoading$ | async)">
                                            <span class="indicator-progress" [style.display]="'block'">
                                                {{ 'profile.edit.pleaseWait' | translate }}
                                                <i class="pi pi-spin pi-spinner" style="font-size: 1rem"></i>
                                            </span>
                                        </ng-container>
                                        <ng-container *ngIf="(isLoading$ | async) === false && !savingContactInfo">
                                            <span>{{ 'profile.edit.saveContactInfo' | translate }}</span>
                                        </ng-container>
                                    </p-button>
                                </div>
                            </div>
                        </div>
                    </form>
                </p-panel>
            </div>

            <!-- User Preferences Panel -->
            <div class="col-12 mt-4">
                <p-panel [header]="'profile.edit.userPreferences' | translate" class="h-full"
                    [style]="{'opacity': '0.6', 'pointer-events': 'none'}">
                    <div *ngIf="loadingPreferences" class="flex justify-content-center align-items-center p-4">
                        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                    </div>
                    <form [formGroup]="preferencesForm" (ngSubmit)="savePreferences()"
                        *ngIf="!loadingPreferences && preferencesForm">
                        <div class="grid">
                            <div class="col-12">
                                <div class="flex justify-content-between align-items-center mb-3">
                                    <p class="m-0 text-600">{{ 'profile.edit.managePreferences' | translate }}</p>
                                    <p-button [label]="'profile.edit.addPreference' | translate" icon="pi pi-plus" size="small"
                                        (onClick)="addPreference()" type="button" [disabled]="true"></p-button>
                                </div>
                            </div>

                            <div class="col-12" *ngIf="getPreferenceKeys().length === 0">
                                <p class="text-center text-600 p-4">{{ 'profile.edit.noPreferencesSet' | translate }}</p>
                            </div>

                            <div class="col-12 md:col-6" *ngFor="let key of getPreferenceKeys()">
                                <div class="field">
                                    <div class="flex align-items-center gap-2 mb-2">
                                        <label class="block text-sm font-medium flex-1">{{ key }}</label>
                                        <button pButton pRipple type="button" icon="pi pi-times"
                                            class="p-button-rounded p-button-danger p-button-text p-button-sm"
                                            (click)="removePreference(key)" [disabled]="true">
                                        </button>
                                    </div>
                                    <input type="text" pInputText [formControlName]="key" [placeholder]="'profile.edit.enterValue' | translate"
                                        class="w-full" [disabled]="true">
                                </div>
                            </div>

                            <div class="col-12" *ngIf="getPreferenceKeys().length > 0">
                                <div class="flex justify-content-start gap-3 my-4">
                                    <p-button [label]="'profile.edit.savePreferences' | translate" icon="pi pi-save" severity="success"
                                        (onClick)="savePreferences()" [disabled]="true">
                                    </p-button>
                                </div>
                            </div>
                        </div>
                    </form>
                </p-panel>
            </div>


        </div>
    </form>
</div>