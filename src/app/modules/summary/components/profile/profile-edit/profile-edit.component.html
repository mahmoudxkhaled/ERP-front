<div class="p-4 card">
    <p-toast></p-toast>

    <!-- Page Header -->
    <div class="flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-3xl font-bold mb-2">{{ translate.getInstant('dashboard.profile') }} - Edit</h1>
            <p class="text-gray-600 m-0">{{ translate.getInstant('profile.description') }}</p>
        </div>
        <p-button label="Back to Overview" icon="pi pi-arrow-left" (onClick)="navigateBack()"></p-button>
    </div>

    <!-- Profile Form -->
    <form [formGroup]="profileForm" (ngSubmit)="saveProfileInfo()" *ngIf="profileForm">
        <div class="grid mt-4">

            <!-- Profile Picture Panel -->
            <div class="col-12 mt-4">
                <p-panel header="Profile Picture" class="h-full">
                    <div *ngIf="loadingProfilePicture" class="flex justify-content-center align-items-center p-4">
                        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                    </div>
                    <div *ngIf="!loadingProfilePicture" class="grid">
                        <div class="col-12 md:col-4">
                            <div class="flex flex-column align-items-center gap-3">
                                <p-avatar [image]="profilePictureUrl" [icon]="!hasProfilePicture ? 'pi pi-user' : ''"
                                    size="xlarge" shape="circle" styleClass="border-3 border-white shadow-4"
                                    [style]="{'width': '150px', 'height': '150px'}">
                                </p-avatar>
                                <p class="text-sm text-600 m-0">Current Profile Picture</p>
                            </div>
                        </div>
                        <div class="col-12 md:col-8">
                            <div class="flex flex-column gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-image mr-2 text-blue-500"></i>
                                        Upload New Picture
                                    </label>
                                    <p-fileUpload mode="basic" name="profilePicture" accept="image/*"
                                        (onSelect)="uploadProfilePicture($event)" [maxFileSize]="2097152"
                                        chooseLabel="Choose Image" [disabled]="uploadingPicture">
                                    </p-fileUpload>
                                    <small class="text-600">Allowed formats: PNG, JPG, JPEG, GIF, BMP, TIFF, PICT. Max
                                        size: 2MB</small>
                                </div>
                                <div *ngIf="hasProfilePicture">
                                    <p-button label="Remove Picture" icon="pi pi-trash" severity="danger"
                                        (onClick)="removeProfilePicture()" [disabled]="uploadingPicture">
                                        <ng-container *ngIf="uploadingPicture">
                                            <span class="indicator-progress" [style.display]="'block'">
                                                Please wait
                                                <i class="pi pi-spin pi-spinner" style="font-size: 1rem"></i>
                                            </span>
                                        </ng-container>
                                    </p-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </p-panel>
            </div>

            <!-- Personal Information Panel -->
            <div class="col-12">
                <p-panel [header]="translate.getInstant('profile.personalInfo')" class="h-full">
                    <div class="grid">
                        <!-- Prefix -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-user mr-2 text-blue-500"></i>
                                    {{ translate.getInstant('profile.fields.prefix') }}
                                </label>
                                <input pInputText formControlName="Prefix"
                                    [placeholder]="translate.getInstant('profile.placeholders.prefix')" class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('Prefix')?.invalid && profileForm.get('Prefix')?.touched}">
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('Prefix')?.invalid && profileForm.get('Prefix')?.touched">
                                    {{ getPrefixError() }}
                                </small>
                            </div>
                        </div>

                        <!-- First Name -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-user mr-2 text-blue-500"></i>
                                    {{ translate.getInstant('profile.fields.firstName') }}
                                    <span class="text-red-500">*</span>
                                </label>
                                <input pInputText formControlName="First_Name"
                                    [placeholder]="translate.getInstant('profile.placeholders.firstName')"
                                    class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('First_Name')?.invalid && profileForm.get('First_Name')?.touched}">
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('First_Name')?.invalid && profileForm.get('First_Name')?.touched">
                                    {{ getFirstNameError() }}
                                </small>
                            </div>
                        </div>

                        <!-- Middle Name -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-user mr-2 text-blue-500"></i>
                                    {{ translate.getInstant('profile.fields.middleName') }}
                                </label>
                                <input pInputText formControlName="Middle_Name"
                                    [placeholder]="translate.getInstant('profile.placeholders.middleName')"
                                    class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('Middle_Name')?.invalid && profileForm.get('Middle_Name')?.touched}">
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('Middle_Name')?.invalid && profileForm.get('Middle_Name')?.touched">
                                    {{ getMiddleNameError() }}
                                </small>
                            </div>
                        </div>

                        <!-- Last Name -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-user mr-2 text-blue-500"></i>
                                    {{ translate.getInstant('profile.fields.lastName') }}
                                    <span class="text-red-500">*</span>
                                </label>
                                <input pInputText formControlName="Last_Name"
                                    [placeholder]="translate.getInstant('profile.placeholders.lastName')" class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('Last_Name')?.invalid && profileForm.get('Last_Name')?.touched}">
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('Last_Name')?.invalid && profileForm.get('Last_Name')?.touched">
                                    {{ getLastNameError() }}
                                </small>
                            </div>
                        </div>

                        <!-- Gender -->
                        <div class="col-12 md:col-6">
                            <div class="field">
                                <label class="block text-sm font-medium mb-2">
                                    <i class="pi pi-users mr-2 text-blue-500"></i>
                                    {{ translate.getInstant('profile.fields.gender') }}
                                </label>
                                <p-dropdown [options]="genderOptions" formControlName="Gender" optionLabel="label"
                                    optionValue="value"
                                    [placeholder]="translate.getInstant('profile.placeholders.selectGender')"
                                    class="w-full"
                                    [ngClass]="{'ng-invalid ng-dirty': profileForm.get('Gender')?.invalid && profileForm.get('Gender')?.touched}">
                                </p-dropdown>
                                <small class="p-error block mt-1"
                                    *ngIf="profileForm.get('Gender')?.invalid && profileForm.get('Gender')?.touched">
                                    Gender is required.
                                </small>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="flex justify-content-end gap-3 my-1">
                                <p-button (onClick)="saveProfileInfo()" [disabled]="saving || !!(isLoading$ | async)">
                                    <ng-container *ngIf="saving || (isLoading$ | async)">
                                        <span class="indicator-progress" [style.display]="'block'">
                                            Please wait
                                            <i class="pi pi-spin pi-spinner" style="font-size: 1rem"></i>
                                        </span>
                                    </ng-container>
                                    <ng-container *ngIf="(isLoading$ | async) === false && !saving">
                                        <span>{{ translate.getInstant('profile.actions.save') }}</span>
                                    </ng-container>
                                </p-button>
                            </div>
                        </div>
                    </div>
                </p-panel>
            </div>

            <!-- Contact Information Panel -->
            <div class="col-12 mt-4">
                <p-panel header="Contact Information" class="h-full">
                    <div *ngIf="loadingContactInfo" class="flex justify-content-center align-items-center p-4">
                        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                    </div>
                    <form [formGroup]="contactInfoForm" (ngSubmit)="saveContactInfo()"
                        *ngIf="!loadingContactInfo && contactInfoForm">
                        <div class="grid">
                            <!-- Address -->
                            <div class="col-12">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-map-marker mr-2 text-blue-500"></i>
                                        Address
                                    </label>
                                    <textarea pInputTextarea formControlName="address" rows="3"
                                        placeholder="Enter address" class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('address')?.invalid && contactInfoForm.get('address')?.touched}"></textarea>
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('address')?.invalid && contactInfoForm.get('address')?.touched">
                                        {{ getAddressError() }}
                                    </small>
                                </div>
                            </div>

                            <!-- Phone Numbers -->
                            <div class="col-12">
                                <div class="flex justify-content-between align-items-center mb-2">
                                    <label class="block text-sm font-medium">
                                        Phone Numbers <span class="text-red-500">*</span>
                                    </label>
                                    <p-button label="Add Phone" icon="pi pi-plus" size="small"
                                        (onClick)="addPhoneNumber()" type="button"></p-button>
                                </div>
                                <div formArrayName="phoneNumbers" class="flex flex-column gap-2">
                                    <div *ngFor="let phoneGroup of phoneNumbersFormArray.controls; let i = index"
                                        [formGroupName]="i" class="flex flex-column gap-1">
                                        <div class="flex align-items-center gap-2">
                                            <input type="text" pInputText formControlName="number"
                                                placeholder="Enter phone number" class="flex-1"
                                                [ngClass]="{'ng-invalid ng-dirty': phoneGroup.get('number')?.invalid && phoneGroup.get('number')?.touched}" />
                                            <button pButton pRipple type="button" icon="pi pi-times"
                                                class="p-button-rounded p-button-danger p-button-text"
                                                (click)="removePhoneNumber(i)" *ngIf="phoneNumbersFormArray.length > 1">
                                            </button>
                                        </div>
                                        <small class="p-error block mt-1"
                                            *ngIf="phoneGroup.get('number')?.invalid && phoneGroup.get('number')?.touched">
                                            {{ getPhoneNumberError(i) }}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Social Media Links -->
                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-linkedin mr-2 text-blue-500"></i>
                                        LinkedIn Page
                                    </label>
                                    <input type="url" pInputText formControlName="linkedinPage"
                                        placeholder="https://linkedin.com/in/..." class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('linkedinPage')?.invalid && contactInfoForm.get('linkedinPage')?.touched}">
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('linkedinPage')?.invalid && contactInfoForm.get('linkedinPage')?.touched">
                                        Please enter a valid URL (must start with http:// or https://).
                                    </small>
                                </div>
                            </div>

                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-facebook mr-2 text-blue-500"></i>
                                        Facebook Page
                                    </label>
                                    <input type="url" pInputText formControlName="facebookPage"
                                        placeholder="https://facebook.com/..." class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('facebookPage')?.invalid && contactInfoForm.get('facebookPage')?.touched}">
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('facebookPage')?.invalid && contactInfoForm.get('facebookPage')?.touched">
                                        Please enter a valid URL (must start with http:// or https://).
                                    </small>
                                </div>
                            </div>

                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-instagram mr-2 text-blue-500"></i>
                                        Instagram Page
                                    </label>
                                    <input type="url" pInputText formControlName="instagramPage"
                                        placeholder="https://instagram.com/..." class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('instagramPage')?.invalid && contactInfoForm.get('instagramPage')?.touched}">
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('instagramPage')?.invalid && contactInfoForm.get('instagramPage')?.touched">
                                        Please enter a valid URL (must start with http:// or https://).
                                    </small>
                                </div>
                            </div>

                            <div class="col-12 md:col-6">
                                <div class="field">
                                    <label class="block text-sm font-medium mb-2">
                                        <i class="pi pi-twitter mr-2 text-blue-500"></i>
                                        Twitter Page
                                    </label>
                                    <input type="url" pInputText formControlName="twitterPage"
                                        placeholder="https://twitter.com/..." class="w-full"
                                        [ngClass]="{'ng-invalid ng-dirty': contactInfoForm.get('twitterPage')?.invalid && contactInfoForm.get('twitterPage')?.touched}">
                                    <small class="p-error block mt-1"
                                        *ngIf="contactInfoForm.get('twitterPage')?.invalid && contactInfoForm.get('twitterPage')?.touched">
                                        Please enter a valid URL (must start with http:// or https://).
                                    </small>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="flex justify-content-end gap-3 my-1">
                                    <p-button (onClick)="saveContactInfo()"
                                        [disabled]="savingContactInfo || !!(isLoading$ | async)">
                                        <ng-container *ngIf="savingContactInfo || (isLoading$ | async)">
                                            <span class="indicator-progress" [style.display]="'block'">
                                                Please wait
                                                <i class="pi pi-spin pi-spinner" style="font-size: 1rem"></i>
                                            </span>
                                        </ng-container>
                                        <ng-container *ngIf="(isLoading$ | async) === false && !savingContactInfo">
                                            <span>Save Contact Info</span>
                                        </ng-container>
                                    </p-button>
                                </div>
                            </div>
                        </div>
                    </form>
                </p-panel>
            </div>

            <!-- User Preferences Panel -->
            <div class="col-12 mt-4">
                <p-panel header="User Preferences" class="h-full"
                    [style]="{'opacity': '0.6', 'pointer-events': 'none'}">
                    <div *ngIf="loadingPreferences" class="flex justify-content-center align-items-center p-4">
                        <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                    </div>
                    <form [formGroup]="preferencesForm" (ngSubmit)="savePreferences()"
                        *ngIf="!loadingPreferences && preferencesForm">
                        <div class="grid">
                            <div class="col-12">
                                <div class="flex justify-content-between align-items-center mb-3">
                                    <p class="m-0 text-600">Manage your user preferences</p>
                                    <p-button label="Add Preference" icon="pi pi-plus" size="small"
                                        (onClick)="addPreference()" type="button" [disabled]="true"></p-button>
                                </div>
                            </div>

                            <div class="col-12" *ngIf="getPreferenceKeys().length === 0">
                                <p class="text-center text-600 p-4">No preferences set</p>
                            </div>

                            <div class="col-12 md:col-6" *ngFor="let key of getPreferenceKeys()">
                                <div class="field">
                                    <div class="flex align-items-center gap-2 mb-2">
                                        <label class="block text-sm font-medium flex-1">{{ key }}</label>
                                        <button pButton pRipple type="button" icon="pi pi-times"
                                            class="p-button-rounded p-button-danger p-button-text p-button-sm"
                                            (click)="removePreference(key)" [disabled]="true">
                                        </button>
                                    </div>
                                    <input type="text" pInputText [formControlName]="key" placeholder="Enter value"
                                        class="w-full" [disabled]="true">
                                </div>
                            </div>

                            <div class="col-12" *ngIf="getPreferenceKeys().length > 0">
                                <div class="flex justify-content-start gap-3 my-4">
                                    <p-button label="Save Preferences" icon="pi pi-save" severity="success"
                                        (onClick)="savePreferences()" [disabled]="true">
                                    </p-button>
                                </div>
                            </div>
                        </div>
                    </form>
                </p-panel>
            </div>


        </div>
    </form>
</div>