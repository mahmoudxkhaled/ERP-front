<div class="p-4 card">
    <p-toast></p-toast>

    <!-- Page Header -->
    <div class="mb-4">
        <h1 class="text-3xl font-bold  mb-2">{{ translate.getInstant('dashboard.profile') }}</h1>
        <p class="text-gray-600">Manage your profile information</p>
    </div>

    <!-- Profile Overview Card -->
    <p-card header="Profile Overview" class="mb-4">
        <div class="flex align-items-center gap-4">
            <p-avatar icon="pi pi-user" size="xlarge" shape="circle"></p-avatar>
            <div>
                <h2 class="text-2xl font-bold  mb-2">
                    {{ profileForm.get('firstName')?.value }} {{ profileForm.get('lastName')?.value }}
                </h2>
                <p-tag [value]="profileForm.get('role')?.value" [severity]="profileForm.get('role')?.value === 'System Admin' ? 'danger' : 
                                   profileForm.get('role')?.value === 'Company Admin' ? 'warning' : 
                                   profileForm.get('role')?.value === 'Supervisor' ? 'info' : 'success'" class="mb-2">
                </p-tag>
                <p class="text-gray-600 flex align-items-center gap-2">
                    <i class="pi pi-envelope text-blue-500"></i>
                    {{ profileForm.get('email')?.value }}
                </p>
            </div>
        </div>
    </p-card>

    <!-- Profile Form -->
    <form [formGroup]="profileForm" (ngSubmit)="saveProfileInfo()" *ngIf="profileForm">
        <div class="grid mt-4">
            <!-- Personal Information Panel -->
            <div class="col-12">
                <p-panel header="Personal Information" class="h-full">
                    <div class="grid">
                        <!-- First Name -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-user mr-2 text-blue-500"></i>
                                First Name
                            </label>
                            <input pInputText formControlName="firstName" placeholder="Enter first name" class="w-full">
                        </div>

                        <!-- Last Name -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-user mr-2 text-blue-500"></i>
                                Last Name
                            </label>
                            <input pInputText formControlName="lastName" placeholder="Enter last name" class="w-full">
                        </div>

                        <!-- Email -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-envelope mr-2 text-blue-500"></i>
                                Email
                            </label>
                            <input pInputText formControlName="email" placeholder="Enter email address" class="w-full">
                        </div>

                        <!-- Phone -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-phone mr-2 text-blue-500"></i>
                                Phone
                            </label>
                            <p-inputMask formControlName="phone" mask="(999) 999-9999" placeholder="(555) 123-4567"
                                class="w-full">
                            </p-inputMask>
                        </div>

                        <!-- Role -->
                        <!-- <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-briefcase mr-2 text-blue-500"></i>
                                Role
                            </label>
                            <p-dropdown [options]="roleOptions" formControlName="role" optionLabel="label"
                                optionValue="value" placeholder="Select role" class="w-full">
                            </p-dropdown>
                        </div> -->

                        <!-- Department -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-building mr-2 text-blue-500"></i>
                                Department
                            </label>
                            <input pInputText formControlName="department" placeholder="Enter department"
                                class="w-full">
                        </div>
                    </div>
                </p-panel>
            </div>
        </div>
    </form>

    <!-- Change Password Section -->
    <div style="margin-bottom: 20px;">

        <p-panel header="Change Password" class="mb-4">
            <!-- Password Requirements Instructions -->
            <div class="mb-4 p-3" style="background-color: #f0f0f0; border-radius: 4px;">
                <h4 class="text-sm font-semibold mb-2">Password Requirements:</h4>
                <ul class="text-sm" style="margin: 0; padding-left: 20px;">
                    <li>Minimum 12 characters</li>
                    <li>Maximum 100 characters</li>
                    <li>At least one uppercase letter (A-Z)</li>
                    <li>At least one lowercase letter (a-z)</li>
                    <li>At least one number (0-9)</li>
                    <li>At least one special character (&#64;#$%^&*()_+!~\-=<>?/|)</li>
                </ul>
            </div>

            <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePassword()">
                <div class="grid">
                    <!-- Old Password -->
                    <div class="col-12 md:col-4">
                        <label class="block text-sm font-medium mb-2">
                            <i class="pi pi-lock mr-2 text-blue-500"></i>
                            Old Password
                        </label>
                        <div class="p-input-icon-right" style="position: relative; display: flex; align-items: center;">
                            <input pInputText [type]="showOldPassword ? 'text' : 'password'"
                                formControlName="oldPassword" placeholder="Enter old password" class="w-full"
                                style="padding-right: 40px;" (keyup)="validateAllPasswordFields()"
                                [ngClass]="{'ng-invalid ng-dirty': changePasswordForm.get('oldPassword')?.invalid && changePasswordForm.get('oldPassword')?.touched}">
                            <i [class]="showOldPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"
                                (click)="togglePasswordVisibility('old')"
                                style="cursor: pointer; position: absolute; right: 12px; color: #6c757d; font-size: 1rem;">
                            </i>
                        </div>
                        <small class="p-error"
                            *ngIf="changePasswordForm.get('oldPassword')?.errors?.['required'] && changePasswordForm.get('oldPassword')?.touched">
                            Old password is required.
                        </small>
                        <small class="p-error"
                            *ngIf="changePasswordForm.get('oldPassword')?.errors?.['oldPasswordWrong'] && changePasswordForm.get('oldPassword')?.touched">
                            The old password you entered is incorrect. Please try again.
                        </small>
                    </div>

                    <!-- New Password -->
                    <div class="col-12 md:col-4">
                        <label class="block text-sm font-medium mb-2">
                            <i class="pi pi-key mr-2 text-blue-500"></i>
                            New Password
                        </label>
                        <div class="p-input-icon-right" style="position: relative; display: flex; align-items: center;">
                            <input pInputText [type]="showNewPassword ? 'text' : 'password'"
                                formControlName="newPassword" placeholder="Enter new password" class="w-full"
                                style="padding-right: 40px;" (keyup)="validateAllPasswordFields()"
                                [ngClass]="{'ng-invalid ng-dirty': changePasswordForm.get('newPassword')?.invalid && changePasswordForm.get('newPassword')?.touched}">
                            <i [class]="showNewPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"
                                (click)="togglePasswordVisibility('new')"
                                style="cursor: pointer; position: absolute; right: 12px; color: #6c757d; font-size: 1rem;">
                            </i>
                        </div>
                        <!-- Validation Messages -->
                        <div class="validation-messages mt-2"
                            *ngIf="changePasswordForm.get('newPassword')?.invalid && (changePasswordForm.get('newPassword')?.dirty || changePasswordForm.get('newPassword')?.touched)">
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['required']">
                                New password is required.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['minlength']">
                                Password must be at least 12 characters long.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['maxlength']">
                                Password must not exceed 100 characters.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['missingUppercase']">
                                Password must contain at least one uppercase letter.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['missingLowercase']">
                                Password must contain at least one lowercase letter.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['missingNumber']">
                                Password must contain at least one number.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['missingSpecialChar']">
                                Password must contain at least one special character.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['passwordSameAsOld']">
                                New password cannot be the same as your old password.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['passwordFormatIncompliant']">
                                Password format is incompliant. Please check the password requirements.
                            </small>
                        </div>
                    </div>

                    <!-- Confirm Password -->
                    <div class="col-12 md:col-4">
                        <label class="block text-sm font-medium mb-2">
                            <i class="pi pi-check-circle mr-2 text-blue-500"></i>
                            Confirm New Password
                        </label>
                        <div class="p-input-icon-right" style="position: relative; display: flex; align-items: center;">
                            <input pInputText [type]="showConfirmPassword ? 'text' : 'password'"
                                formControlName="confirmPassword" placeholder="Confirm new password" class="w-full"
                                style="padding-right: 40px;" (keyup)="validateAllPasswordFields()"
                                [ngClass]="{'ng-invalid ng-dirty': changePasswordForm.get('confirmPassword')?.invalid && changePasswordForm.get('confirmPassword')?.touched}">
                            <i [class]="showConfirmPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"
                                (click)="togglePasswordVisibility('confirm')"
                                style="cursor: pointer; position: absolute; right: 12px; color: #6c757d; font-size: 1rem;">
                            </i>
                        </div>
                        <small class="p-error"
                            *ngIf="changePasswordForm.get('confirmPassword')?.errors?.['passwordMismatch'] && changePasswordForm.get('confirmPassword')?.touched">
                            Passwords do not match.
                        </small>
                        <small class="p-error"
                            *ngIf="changePasswordForm.get('confirmPassword')?.errors?.['required'] && changePasswordForm.get('confirmPassword')?.touched">
                            Please confirm your password.
                        </small>
                    </div>
                </div>
                <div class="flex justify-content-end mt-3">
                    <p-button label="Change Password" icon="pi pi-save" severity="success" type="submit"
                        [disabled]="changePasswordForm.invalid"></p-button>
                </div>
            </form>
        </p-panel>
    </div>

    <!-- 2FA Settings Section -->
    <p-panel header="Two-Factor Authentication (2FA)" class="mb-4 mt-4">
        <div class="flex align-items-center justify-content-between mb-3">
            <div>
                <h3 class="text-lg font-semibold mb-2">2FA Status</h3>
                <p class="text-gray-600">
                    {{ twoFactorEnabled ? 'Two-factor authentication is enabled.' : 'Two-factor authentication is
                    disabled.' }}
                </p>
            </div>
            <p-button [label]="twoFactorEnabled ? 'Disable 2FA' : 'Enable 2FA'"
                [icon]="twoFactorEnabled ? 'pi pi-times' : 'pi pi-shield'"
                [severity]="twoFactorEnabled ? 'danger' : 'success'" (onClick)="toggle2FA()">
            </p-button>
        </div>
    </p-panel>

    <!-- Action Buttons -->
    <div class="flex justify-content-center gap-3 my-4">
        <p-button label="Save Changes" icon="pi pi-save" severity="success" (onClick)="saveProfileInfo()"></p-button>
        <p-button label="Reset" icon="pi pi-refresh" severity="secondary" (onClick)="resetForm()"></p-button>
        <p-button label="Cancel" icon="pi pi-times" severity="danger" (onClick)="cancelEdit()"></p-button>
    </div>
</div>

<!-- Change Password Confirmation Dialog -->
<p-dialog [(visible)]="showChangePasswordDialog" [modal]="true" [style]="{ width: '500px' }" header="Change Password">
    <div class="flex flex-column align-items-center gap-3">
        <i class="pi pi-key" style="font-size: 3rem; color: var(--primary-color);"></i>
        <div class="text-center">
            <p class="text-lg font-semibold mb-2">
                Change Your Password?
            </p>
            <p class="text-gray-600 mb-2">
                You are about to change your account password.
            </p>
            <p class="text-gray-600 mb-2">
                <strong>Important:</strong> This change will take effect on your next login.
            </p>
            <p class="text-gray-600">
                You will need to use your new password to log in to your account after you sign out or your current
                session expires.
            </p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" severity="secondary" (onClick)="cancelChangePassword()"
            class="p-button-text"></p-button>
        <p-button label="Change Password" icon="pi pi-check" severity="success"
            (onClick)="confirmChangePassword()"></p-button>
    </ng-template>
</p-dialog>

<!-- 2FA Confirmation Dialog -->
<p-dialog [(visible)]="show2FADialog" [modal]="true" [style]="{ width: '500px' }"
    [header]="twoFactorEnabled ? 'Disable Two-Factor Authentication' : 'Enable Two-Factor Authentication'">
    <div class="flex flex-column align-items-center gap-3">
        <i [class]="twoFactorEnabled ? 'pi pi-exclamation-triangle' : 'pi pi-shield'"
            style="font-size: 3rem; color: var(--primary-color);"></i>
        <div class="text-center">
            <p class="text-lg font-semibold mb-2">
                {{ twoFactorEnabled ? 'Disable Two-Factor Authentication?' : 'Enable Two-Factor Authentication?' }}
            </p>
            <p class="text-gray-600 mb-2">
                {{ twoFactorEnabled
                ? 'You are about to disable two-factor authentication for your account.'
                : 'You are about to enable two-factor authentication for your account.' }}
            </p>
            <p class="text-gray-600 mb-2">
                <strong>Important:</strong> This change will take effect on your next login.
            </p>
            <p class="text-gray-600">
                An email with a verification code will be sent to your registered email address.
                You will need to enter this code to complete your login.
            </p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" severity="secondary" (onClick)="cancelToggle2FA()"
            class="p-button-text"></p-button>
        <p-button [label]="twoFactorEnabled ? 'Disable 2FA' : 'Enable 2FA'"
            [icon]="twoFactorEnabled ? 'pi pi-times' : 'pi pi-check'"
            [severity]="twoFactorEnabled ? 'danger' : 'success'" (onClick)="confirmToggle2FA()"></p-button>
    </ng-template>
</p-dialog>