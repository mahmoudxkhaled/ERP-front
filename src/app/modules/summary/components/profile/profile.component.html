<div class="p-4 card">
    <p-toast></p-toast>

    <!-- Page Header -->
    <div class="mb-4">
        <h1 class="text-3xl font-bold  mb-2">{{ translate.getInstant('dashboard.profile') }}</h1>
        <p class="text-gray-600">Manage your profile information</p>
    </div>

    <!-- Profile Overview Card -->
    <p-card [style]="{'border-radius': '16px', 'box-shadow': '0 4px 20px rgba(0,0,0,0.08)'}" class="mb-4">
        <ng-template pTemplate="header">
            <div class="p-4 surface-ground border-round-top">
                <h2 class="  m-0 text-2xl font-bold">
                    <i class="pi pi-user mr-2"></i>
                    Profile Overview
                </h2>
            </div>
        </ng-template>
        <div class="p-4">
            <div class="flex flex-column md:flex-row align-items-start md:align-items-center gap-4">
                <!-- Avatar Section -->
                <div class="flex-shrink-0">
                    <p-avatar [image]="profilePictureUrl || 'assets/media/avatar.png'"
                        [icon]="!profilePictureUrl ? 'pi pi-user' : ''" size="xlarge" shape="circle"
                        styleClass="border-3 border-white shadow-4" [style]="{'width': '120px', 'height': '120px'}">
                    </p-avatar>
                </div>

                <!-- Profile Information -->
                <div class="flex-1 w-full">
                    <h3 class="text-3xl font-bold m-0 mb-3 text-900">
                        {{ profileForm.get('Prefix')?.value }} {{ profileForm.get('First_Name')?.value }}
                        {{ profileForm.get('Middle_Name')?.value }} {{ profileForm.get('Last_Name')?.value }}
                    </h3>

                    <!-- Email -->
                    <div class="flex align-items-center gap-2 mb-3 p-3 surface-100 border-round"
                        style="background: var(--surface-50);">
                        <div class="flex align-items-center justify-content-center border-circle bg-primary"
                            style="width: 40px; height: 40px; min-width: 40px;">
                            <i class="pi pi-envelope text-white text-lg"></i>
                        </div>
                        <div>
                            <p class="text-sm text-color-secondary m-0 font-medium">Email Address</p>
                            <p class="text-lg font-semibold m-0 text-900">{{ profileForm.get('Email')?.value }}</p>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3 p-3 surface-100 border-round" *ngIf="profileForm.get('Description')?.value"
                        style="background: var(--surface-50);">
                        <div class="flex align-items-start gap-2">
                            <div class="flex align-items-center justify-content-center border-circle bg-primary"
                                style="width: 40px; height: 40px; min-width: 40px;">
                                <i class="pi pi-info-circle text-white text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-color-secondary m-0 mb-1 font-medium">Account</p>
                                <p class="text-base m-0 text-900 line-height-3">{{ profileForm.get('Description')?.value
                                    }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Company -->
                    <div class="p-3 surface-100 border-round" *ngIf="profileForm.get('Entity_Name')?.value"
                        style="background: var(--surface-50);">
                        <div class="flex align-items-center gap-2">
                            <div class="flex align-items-center justify-content-center border-circle bg-primary"
                                style="width: 40px; height: 40px; min-width: 40px;">
                                <i class="pi pi-building text-white text-lg"></i>
                            </div>
                            <div>
                                <p class="text-sm text-color-secondary m-0 font-medium">Company</p>
                                <p class="text-lg font-semibold m-0 text-900">{{ profileForm.get('Entity_Name')?.value
                                    }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </p-card>

    <!-- Profile Form -->
    <form [formGroup]="profileForm" (ngSubmit)="saveProfileInfo()" *ngIf="profileForm">
        <div class="grid mt-4">
            <!-- Personal Information Panel -->
            <div class="col-12">
                <p-panel header="Personal Information" class="h-full">
                    <div class="grid">
                        <!-- Prefix -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-user mr-2 text-blue-500"></i>
                                Prefix
                            </label>
                            <input pInputText formControlName="Prefix" placeholder="Enter prefix (e.g., Mr., Mrs., Dr.)"
                                class="w-full">
                        </div>

                        <!-- First Name -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-user mr-2 text-blue-500"></i>
                                First Name
                            </label>
                            <input pInputText formControlName="First_Name" placeholder="Enter first name"
                                class="w-full">
                        </div>

                        <!-- Middle Name -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-user mr-2 text-blue-500"></i>
                                Middle Name
                            </label>
                            <input pInputText formControlName="Middle_Name" placeholder="Enter middle name"
                                class="w-full">
                        </div>

                        <!-- Last Name -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-user mr-2 text-blue-500"></i>
                                Last Name
                            </label>
                            <input pInputText formControlName="Last_Name" placeholder="Enter last name" class="w-full">
                        </div>

                        <!-- Email -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-envelope mr-2 text-blue-500"></i>
                                Email
                            </label>
                            <input pInputText formControlName="Email" placeholder="Enter email address" class="w-full">
                        </div>

                        <!-- Gender -->
                        <div class="col-12 md:col-6">
                            <label class="block text-sm font-medium  mb-2">
                                <i class="pi pi-users mr-2 text-blue-500"></i>
                                Gender
                            </label>
                            <p-dropdown [options]="genderOptions" formControlName="Gender" optionLabel="label"
                                optionValue="value" placeholder="Select gender" class="w-full">
                            </p-dropdown>
                        </div>


                        <div class="col-12 md:col-6">
                            <div class="flex justify-content-start gap-3 my-4">
                                <p-button label="Save Changes" icon="pi pi-save" severity="success"
                                    (onClick)="saveProfileInfo()"></p-button>
                            </div>
                        </div>
                    </div>
                </p-panel>
            </div>
        </div>
    </form>
    <!-- Action Buttons -->


    <!-- Change Password Section -->
    <div style="margin-bottom: 20px;">

        <p-panel header="Change Password" class="mb-4">

            <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePassword()">
                <div class="grid">
                    <!-- Old Password -->
                    <div class="col-12 md:col-4">
                        <label class="block text-sm font-medium mb-2">
                            <i class="pi pi-lock mr-2 text-blue-500"></i>
                            Old Password
                        </label>
                        <div class="p-input-icon-right" style="position: relative; display: flex; align-items: center;">
                            <input pInputText [type]="showOldPassword ? 'text' : 'password'"
                                formControlName="oldPassword" placeholder="Enter old password" class="w-full"
                                style="padding-right: 40px;" (keyup)="validateAllPasswordFields()"
                                [ngClass]="{'ng-invalid ng-dirty': changePasswordForm.get('oldPassword')?.invalid && changePasswordForm.get('oldPassword')?.touched}">
                            <i [class]="showOldPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"
                                (click)="togglePasswordVisibility('old')"
                                style="cursor: pointer; position: absolute; right: 12px; color: #6c757d; font-size: 1rem;">
                            </i>
                        </div>
                        <small class="p-error"
                            *ngIf="changePasswordForm.get('oldPassword')?.errors?.['required'] && changePasswordForm.get('oldPassword')?.touched">
                            Old password is required.
                        </small>
                        <small class="p-error"
                            *ngIf="changePasswordForm.get('oldPassword')?.errors?.['oldPasswordWrong'] && changePasswordForm.get('oldPassword')?.touched">
                            The old password you entered is incorrect. Please try again.
                        </small>
                    </div>

                    <!-- New Password -->
                    <div class="col-12 md:col-4">
                        <label class="block text-sm font-medium mb-2">
                            <i class="pi pi-key mr-2 text-blue-500"></i>
                            New Password
                        </label>
                        <div class="p-input-icon-right" style="position: relative; display: flex; align-items: center;">
                            <input pInputText [type]="showNewPassword ? 'text' : 'password'"
                                formControlName="newPassword" placeholder="Enter new password" class="w-full"
                                style="padding-right: 40px;" (keyup)="validateAllPasswordFields()"
                                [ngClass]="{'ng-invalid ng-dirty': changePasswordForm.get('newPassword')?.invalid && changePasswordForm.get('newPassword')?.touched}">
                            <i [class]="showNewPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"
                                (click)="togglePasswordVisibility('new')"
                                style="cursor: pointer; position: absolute; right: 12px; color: #6c757d; font-size: 1rem;">
                            </i>
                        </div>

                        <!-- Password Length Indicator -->
                        <div *ngIf="getPasswordLength() > 0" style="margin-top: 0.5rem; margin-bottom: 0.75rem;">
                            <span [style.color]="checkPasswordLength() ? '#22c55e' : '#6b7280'"
                                [style.font-weight]="checkPasswordLength() ? '600' : '400'" [style.font-size]="'1rem'">
                                {{ getPasswordLength() }}
                            </span>
                        </div>

                        <!-- Real-time Password Validation Rules -->
                        <div *ngIf="changePasswordForm.get('newPassword')?.value" style="margin-top: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i [class]="checkPasswordLength() ? 'pi pi-check-circle' : 'pi pi-circle'"
                                    [style.color]="checkPasswordLength() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 1rem;"></i>
                                <span [style.color]="checkPasswordLength() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 0.875rem;">
                                    Between 8-15 characters
                                </span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i [class]="checkStartsWithLetter() ? 'pi pi-check-circle' : 'pi pi-circle'"
                                    [style.color]="checkStartsWithLetter() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 1rem;"></i>
                                <span [style.color]="checkStartsWithLetter() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 0.875rem;">
                                    Starts with a letter (uppercase or lowercase)
                                </span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i [class]="checkHasUppercaseAndLowercase() ? 'pi pi-check-circle' : 'pi pi-circle'"
                                    [style.color]="checkHasUppercaseAndLowercase() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 1rem;"></i>
                                <span [style.color]="checkHasUppercaseAndLowercase() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 0.875rem;">
                                    At least one uppercase and one lowercase letter
                                </span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i [class]="checkHasNumber() ? 'pi pi-check-circle' : 'pi pi-circle'"
                                    [style.color]="checkHasNumber() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 1rem;"></i>
                                <span [style.color]="checkHasNumber() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 0.875rem;">
                                    At least one number
                                </span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i [class]="checkHasSpecialChar() ? 'pi pi-check-circle' : 'pi pi-circle'"
                                    [style.color]="checkHasSpecialChar() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 1rem;"></i>
                                <span [style.color]="checkHasSpecialChar() ? '#22c55e' : '#6b7280'"
                                    style="font-size: 0.875rem;">
                                    At least one special character (non-alphanumeric)
                                </span>
                            </div>
                        </div>

                        <!-- Error Messages for other validations -->
                        <div class="validation-messages mt-2"
                            *ngIf="changePasswordForm.get('newPassword')?.invalid && (changePasswordForm.get('newPassword')?.dirty || changePasswordForm.get('newPassword')?.touched)">
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['required']">
                                New password is required.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['passwordSameAsOld']">
                                New password cannot be the same as your old password.
                            </small>
                            <small class="p-error block"
                                *ngIf="changePasswordForm.get('newPassword')?.errors?.['passwordFormatIncompliant']">
                                Password format is incompliant. Please check the password requirements.
                            </small>
                        </div>
                    </div>

                    <!-- Confirm Password -->
                    <div class="col-12 md:col-4">
                        <label class="block text-sm font-medium mb-2">
                            <i class="pi pi-check-circle mr-2 text-blue-500"></i>
                            Confirm New Password
                        </label>
                        <div class="p-input-icon-right" style="position: relative; display: flex; align-items: center;">
                            <input pInputText [type]="showConfirmPassword ? 'text' : 'password'"
                                formControlName="confirmPassword" placeholder="Confirm new password" class="w-full"
                                style="padding-right: 40px;" (keyup)="validateAllPasswordFields()"
                                [ngClass]="{'ng-invalid ng-dirty': changePasswordForm.get('confirmPassword')?.invalid && changePasswordForm.get('confirmPassword')?.touched}">
                            <i [class]="showConfirmPassword ? 'pi pi-eye-slash' : 'pi pi-eye'"
                                (click)="togglePasswordVisibility('confirm')"
                                style="cursor: pointer; position: absolute; right: 12px; color: #6c757d; font-size: 1rem;">
                            </i>
                        </div>
                        <small class="p-error"
                            *ngIf="changePasswordForm.get('confirmPassword')?.errors?.['passwordMismatch'] && changePasswordForm.get('confirmPassword')?.touched">
                            Passwords do not match.
                        </small>
                        <small class="p-error"
                            *ngIf="changePasswordForm.get('confirmPassword')?.errors?.['required'] && changePasswordForm.get('confirmPassword')?.touched">
                            Please confirm your password.
                        </small>
                    </div>
                </div>
                <div class="flex justify-content-end mt-3">
                    <p-button label="Change Password" icon="pi pi-save" severity="success" type="submit"
                        [disabled]="changePasswordForm.invalid"></p-button>
                </div>
            </form>
        </p-panel>
    </div>

    <!-- 2FA Settings Section -->
    <p-panel header="Two-Factor Authentication (2FA)" class="mb-4 mt-4">
        <div class="flex align-items-center justify-content-between mb-3">
            <div>
                <h3 class="text-lg font-semibold mb-2">2FA Status</h3>
                <p class="text-gray-600">
                    {{ twoFactorEnabled ? 'Two-factor authentication is enabled.' : 'Two-factor authentication is
                    disabled.' }}
                </p>
            </div>
            <p-button [label]="twoFactorEnabled ? 'Disable 2FA' : 'Enable 2FA'"
                [icon]="twoFactorEnabled ? 'pi pi-times' : 'pi pi-shield'"
                [severity]="twoFactorEnabled ? 'danger' : 'success'" (onClick)="toggle2FA()">
            </p-button>
        </div>

    </p-panel>


</div>

<!-- Change Password Confirmation Dialog -->
<p-dialog [(visible)]="showChangePasswordDialog" [modal]="true" [style]="{ width: '500px' }" header="Change Password">
    <div class="flex flex-column align-items-center gap-3">
        <i class="pi pi-key" style="font-size: 3rem; color: var(--primary-color);"></i>
        <div class="text-center">
            <p class="text-lg font-semibold mb-2">
                Change Your Password?
            </p>
            <p class="text-gray-600 mb-2">
                You are about to change your account password.
            </p>
            <p class="text-gray-600 mb-2">
                <strong>Important:</strong> This change will take effect on your next login.
            </p>
            <p class="text-gray-600">
                You will need to use your new password to log in to your account after you sign out or your current
                session expires.
            </p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" severity="secondary" (onClick)="cancelChangePassword()"
            class="p-button-text"></p-button>
        <p-button label="Change Password" icon="pi pi-check" severity="success"
            (onClick)="confirmChangePassword()"></p-button>
    </ng-template>
</p-dialog>

<!-- 2FA Confirmation Dialog -->
<p-dialog [(visible)]="show2FADialog" [modal]="true" [style]="{ width: '500px' }"
    [header]="twoFactorEnabled ? 'Disable Two-Factor Authentication' : 'Enable Two-Factor Authentication'">
    <div class="flex flex-column align-items-center gap-3">
        <i [class]="twoFactorEnabled ? 'pi pi-exclamation-triangle' : 'pi pi-shield'"
            style="font-size: 3rem; color: var(--primary-color);"></i>
        <div class="text-center">
            <p class="text-lg font-semibold mb-2">
                {{ twoFactorEnabled ? 'Disable Two-Factor Authentication?' : 'Enable Two-Factor Authentication?' }}
            </p>
            <p class="text-gray-600 mb-2">
                {{ twoFactorEnabled
                ? 'You are about to disable two-factor authentication for your account.'
                : 'You are about to enable two-factor authentication for your account.' }}
            </p>
            <p class="text-gray-600 mb-2">
                <strong>Important:</strong> This change will take effect on your next login.
            </p>
            <p class="text-gray-600">
                An email with a verification code will be sent to your registered email address.
                You will need to enter this code to complete your login.
            </p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" severity="secondary" (onClick)="cancelToggle2FA()"
            class="p-button-text"></p-button>
        <p-button [label]="twoFactorEnabled ? 'Disable 2FA' : 'Enable 2FA'"
            [icon]="twoFactorEnabled ? 'pi pi-times' : 'pi pi-check'"
            [severity]="twoFactorEnabled ? 'danger' : 'success'" (onClick)="confirmToggle2FA()"></p-button>
    </ng-template>
</p-dialog>