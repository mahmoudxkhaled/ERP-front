<div class="block-section">
    <h2 class="block-title">{{ 'fileSystem.entityAdmin.fileSystemsByEntity' | translate }}</h2>
    <div class="block-card">
        <p class="mb-3 text-500">{{ 'fileSystem.entityAdmin.fileSystemsHostedInDrives' | translate }}</p>

        <div class="mb-3 flex flex-wrap gap-2 align-items-center">
            <p-button [label]="'fileSystem.entityAdmin.createFileSystem' | translate" icon="pi pi-plus"
                (onClick)="showCreateDialog()"></p-button>
            <p-button [label]="'fileSystem.companyStorage.recycleBin' | translate" icon="pi pi-replay"
                styleClass="p-button-outlined" (onClick)="showRecycleBinDialog()"></p-button>
        </div>

        <p-table [value]="fileSystems" [paginator]="false" [loading]="loadingFileSystems"
            styleClass="p-datatable-sm p-datatable-gridlines" responsiveLayout="scroll">
            <ng-template pTemplate="header">
                <tr>
                    <th>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</th>
                    <th>{{ 'fileSystem.entityAdmin.fileSystemType' | translate }}</th>
                    <th>{{ 'fileSystem.admin.driveName' | translate }}</th>
                    <th style="width: 12rem">{{ 'fileSystem.companyStorage.actions' | translate }}</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
                <tr>
                    <td>{{ getFileSystemName(row) }}</td>
                    <td>{{ getTypeName(row) }}</td>
                    <td>{{ getDriveName(row) }}</td>
                    <td>
                        <button pButton type="button" icon="pi pi-eye" class="p-button-text p-button-sm mr-1"
                            [pTooltip]="'fileSystem.admin.viewDetails' | translate"
                            (click)="showDetailsDialog(row)"></button>
                        <button pButton type="button" icon="pi pi-pencil" class="p-button-text p-button-sm mr-1"
                            [pTooltip]="'fileSystem.entityAdmin.editFileSystem' | translate"
                            (click)="showEditDialog(row)"></button>
                        <button pButton type="button" icon="pi pi-trash"
                            class="p-button-text p-button-sm mr-1 p-button-danger"
                            [pTooltip]="'fileSystem.entityAdmin.deleteFileSystem' | translate"
                            (click)="showDeleteConfirm(row)"></button>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Create -->
<p-dialog [header]="'fileSystem.entityAdmin.createFileSystemDialogTitle' | translate" [(visible)]="createDialogVisible"
    [modal]="true" [style]="{ width: '450px' }" (onHide)="hideCreateDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label>{{ 'fileSystem.admin.scopeLabel' | translate }}</label>
            <div class="flex flex-column gap-2 mt-2">
                <div class="flex align-items-center">
                    <p-radioButton name="scope" value="personal" [(ngModel)]="newFileSystemScope"
                        [inputId]="'scope-personal'" />
                    <label [for]="'scope-personal'" class="ml-2">{{ 'fileSystem.admin.scopePersonal' | translate
                        }}</label>
                </div>
                <div class="flex align-items-center" *ngIf="canChooseEntityScope">
                    <p-radioButton name="scope" value="entity" [(ngModel)]="newFileSystemScope"
                        [inputId]="'scope-entity'" />
                    <label [for]="'scope-entity'" class="ml-2">{{ 'fileSystem.admin.scopeEntity' | translate }}</label>
                </div>
            </div>
        </div>
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
            <input pInputText [(ngModel)]="newFileSystemName" class="w-full mt-2" />
        </div>
        <div class="field mb-3">
            <label>{{ 'fileSystem.admin.driveName' | translate }}</label>
            <p-dropdown appendTo="body" [options]="driveOptions" [(ngModel)]="newFileSystemDriveId" optionLabel="name"
                optionValue="id" [style]="{ width: '100%' }" [placeholder]="'fileSystem.admin.selectDrive' | translate"
                class="mt-2"></p-dropdown>
        </div>
        <div class="field">
            <label>{{ 'fileSystem.entityAdmin.fileSystemType' | translate }}</label>
            <p-dropdown appendTo="body" [options]="fileSystemTypes" [(ngModel)]="newFileSystemTypeId" optionLabel="name"
                optionValue="id" [style]="{ width: '100%' }" [disabled]="loadingTypes"
                [placeholder]="'fileSystem.admin.selectType' | translate" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideCreateDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.create' | translate" (onClick)="onCreateConfirm()"
            [loading]="creatingFileSystem"></p-button>
    </ng-template>
</p-dialog>

<!-- Edit -->
<p-dialog [header]="'fileSystem.entityAdmin.editFileSystemDialogTitle' | translate" [(visible)]="editDialogVisible"
    [modal]="true" [style]="{ width: '450px' }" (onHide)="hideEditDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid" *ngIf="selectedForEdit">
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
            <input pInputText [(ngModel)]="editFileSystemName" class="w-full mt-2" />
        </div>
        <div class="field">
            <label>{{ 'fileSystem.entityAdmin.fileSystemType' | translate }}</label>
            <p-dropdown [options]="fileSystemTypes" [(ngModel)]="editFileSystemTypeId" optionLabel="name"
                optionValue="id" [style]="{ width: '100%' }" [disabled]="loadingTypes"
                [placeholder]="'fileSystem.admin.selectType' | translate" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideEditDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.save' | translate" (onClick)="onEditSave()"
            [loading]="savingFileSystem"></p-button>
    </ng-template>
</p-dialog>

<!-- File System Details -->
<p-dialog [header]="'fileSystem.entityAdmin.fileSystemDetailsTitle' | translate" [(visible)]="detailsDialogVisible"
    [modal]="true" [style]="{ width: '420px' }" (onHide)="hideDetailsDialog()" [draggable]="false" [resizable]="false"
    styleClass="drive-details-dialog">
    <div class="drive-details-content" *ngIf="detailsLoading">
        <div class="drive-details-row drive-details-name">
            <span class="drive-details-label">{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</span>
            <p-skeleton height="1.25rem" width="10rem"></p-skeleton>
        </div>
        <div class="drive-details-divider"></div>
        <div class="drive-details-row">
            <span class="drive-details-label">{{ 'fileSystem.entityAdmin.fileSystemType' | translate }}</span>
            <p-skeleton height="1rem" width="6rem"></p-skeleton>
        </div>
        <div class="drive-details-row">
            <span class="drive-details-label">{{ 'fileSystem.admin.driveName' | translate }}</span>
            <p-skeleton height="1rem" width="8rem"></p-skeleton>
        </div>
        <div class="drive-details-row">
            <span class="drive-details-label">{{ 'fileSystem.admin.createdAt' | translate }}</span>
            <p-skeleton height="1rem" width="8rem"></p-skeleton>
        </div>
        <div class="drive-details-divider"></div>
        <div class="drive-details-row drive-details-status-row mt-2">
            <span class="drive-details-label">{{ 'fileSystem.entityAdmin.status' | translate }}</span>
            <p-skeleton height="1.5rem" width="4rem" borderRadius="4px"></p-skeleton>
        </div>
    </div>
    <div class="drive-details-content" *ngIf="!detailsLoading && detailsData">
        <div class="drive-details-row drive-details-name">
            <span class="drive-details-label">{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</span>
            <span class="drive-details-value font-semibold">{{ detailsData.name }}</span>
        </div>
        <div class="drive-details-divider"></div>
        <div class="drive-details-row">
            <span class="drive-details-label">{{ 'fileSystem.entityAdmin.fileSystemType' | translate }}</span>
            <span class="drive-details-value">{{ detailsData.typeName }}</span>
        </div>
        <div class="drive-details-row">
            <span class="drive-details-label">{{ 'fileSystem.admin.driveName' | translate }}</span>
            <span class="drive-details-value">{{ detailsData.driveName }}</span>
        </div>
        <div class="drive-details-row">
            <span class="drive-details-label">{{ 'fileSystem.admin.createdAt' | translate }}</span>
            <span class="drive-details-value">{{ detailsData.createdAt ? (detailsData.createdAt | date:'medium') : '—' }}</span>
        </div>
        <div class="drive-details-divider"></div>
        <div class="drive-details-row drive-details-status-row mt-2">
            <span class="drive-details-label">{{ 'fileSystem.entityAdmin.status' | translate }}</span>
            <p-tag
                [value]="detailsData.active ? ('fileSystem.entityAdminStatus.active' | translate) : ('fileSystem.admin.inactive' | translate)"
                [severity]="detailsData.active ? 'success' : 'secondary'"></p-tag>
        </div>
    </div>
    <!-- <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" (onClick)="hideDetailsDialog()"></p-button>
    </ng-template> -->
</p-dialog>

<!-- Delete confirm (ESM) -->
<p-dialog [header]="'fileSystem.entityAdmin.deleteFileSystem' | translate" [(visible)]="deleteConfirmVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideDeleteConfirm()" [draggable]="false" [resizable]="false">
    <p *ngIf="selectedForDelete">{{ 'fileSystem.entityAdmin.confirmDeleteFileSystem' | translate: { name:
        selectedForDelete.name } }}</p>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideDeleteConfirm()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.delete' | translate" severity="danger"
            (onClick)="onDeleteConfirm()" [loading]="deletingFileSystem"></p-button>
    </ng-template>
</p-dialog>

<!-- Recycle bin (ESM) -->
<p-dialog [header]="'fileSystem.companyStorage.recycleBinTitle' | translate" [(visible)]="recycleBinDialogVisible"
    [modal]="true" [style]="{ width: '500px' }" (onHide)="hideRecycleBinDialog()" [draggable]="false"
    [resizable]="false">
    <p class="mb-3">{{ 'fileSystem.companyStorage.recycleBinDescription' | translate }}</p>
    <div class="field mb-3">
        <label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
        <p-dropdown [options]="fileSystems" [(ngModel)]="recycleBinFileSystemId" optionLabel="name"
            optionValue="file_System_ID" [style]="{ width: '100%' }"
            [placeholder]="'fileSystem.admin.selectType' | translate" (onChange)="onRecycleBinFileSystemSelect()"
            class="mt-2"></p-dropdown>
    </div>
    <p *ngIf="loadingRecycleBin">{{ 'fileSystem.companyStorage.loading' | translate }}</p>
    <div *ngIf="!loadingRecycleBin && recycleBinContents && recycleBinFileSystemId">
        <p class="mb-2"
            *ngIf="(recycleBinContents.folders?.length || 0) + (recycleBinContents.files?.length || 0) === 0">{{
            'fileSystem.companyStorage.recycleBinEmpty' | translate }}</p>
        <ul *ngIf="(recycleBinContents.folders?.length || 0) + (recycleBinContents.files?.length || 0) > 0"
            class="list-none p-0">
            <li *ngFor="let f of recycleBinContents.folders">{{ f?.folder_Name ?? f?.Folder_Name ?? f?.name ?? '—' }}
            </li>
            <li *ngFor="let f of recycleBinContents.files">{{ f?.file_Name ?? f?.File_Name ?? f?.name ?? '—' }}</li>
        </ul>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.entityAdmin.restoreFileSystem' | translate" icon="pi pi-replay"
            [disabled]="!recycleBinFileSystemId || loadingRecycleBin" (onClick)="onRecycleBinRestoreAll()"
            [loading]="restoringRecycleBin" class="mr-2"></p-button>
        <p-button [label]="'fileSystem.companyStorage.clearRecycleBin' | translate" severity="danger"
            [disabled]="!recycleBinFileSystemId || loadingRecycleBin" (onClick)="onRecycleBinClear()"
            [loading]="clearingRecycleBin"></p-button>
        <p-button [label]="'fileSystem.companyStorage.close' | translate" (onClick)="hideRecycleBinDialog()"></p-button>
    </ng-template>
</p-dialog>