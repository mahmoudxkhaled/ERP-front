<div class="block-section">
    <h2 class="block-title" *ngIf="mode === 'ssm'">{{ 'fileSystem.admin.listFileSystems' | translate }}</h2>
    <h2 class="block-title" *ngIf="mode === 'esm'">{{ 'fileSystem.entityAdmin.fileSystemsByEntity' | translate }}</h2>
    <div class="block-card">
        <p class="mb-3 text-500" *ngIf="mode === 'ssm'">{{ 'fileSystem.admin.createFileSystemRequiresEntityAdmin' |
            translate }}</p>
        <p class="mb-3 text-500" *ngIf="mode === 'esm'">{{ 'fileSystem.entityAdmin.fileSystemsHostedInDrives' |
            translate }}</p>

        <div class="mb-3" *ngIf="mode === 'ssm'">
            <label class="mr-2">{{ 'fileSystem.admin.driveName' | translate }}</label>
            <p-dropdown [options]="driveOptions" [(ngModel)]="selectedDriveId" optionLabel="name" optionValue="id"
                [style]="{ width: '280px' }"
                [placeholder]="'fileSystem.admin.selectDriveToManageFileSystems' | translate"
                (onChange)="onDriveSelected()"></p-dropdown>
        </div>

        <div class="mb-3 flex flex-wrap gap-2 align-items-center" *ngIf="mode === 'esm'">
            <p-button [label]="'fileSystem.entityAdmin.createFileSystem' | translate" icon="pi pi-plus"
                (onClick)="showCreateDialog()"></p-button>
            <p-button [label]="'fileSystem.companyStorage.recycleBin' | translate" icon="pi pi-replay"
                styleClass="p-button-outlined" (onClick)="showRecycleBinDialog()"></p-button>
        </div>

        <p-table [value]="fileSystems" [paginator]="false" [loading]="loadingFileSystems"
            styleClass="p-datatable-sm p-datatable-gridlines" responsiveLayout="scroll">
            <ng-template pTemplate="header">
                <tr>
                    <th *ngIf="mode === 'esm'">{{ 'fileSystem.entityAdmin.entityName' | translate }}</th>
                    <th>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</th>
                    <th *ngIf="mode === 'ssm'">{{ 'fileSystem.entityAdmin.entityName' | translate }}</th>
                    <th>{{ 'fileSystem.entityAdmin.status' | translate }}</th>
                    <th>{{ 'fileSystem.entityAdmin.usedCapacity' | translate }}</th>
                    <th style="width: 12rem">{{ 'fileSystem.companyStorage.actions' | translate }}</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row>
                <tr>
                    <td *ngIf="mode === 'esm'" class="cell-entity">{{ getEntityName(row) }}</td>
                    <td>{{ getFileSystemName(row) }}</td>
                    <td *ngIf="mode === 'ssm'">{{ getEntityName(row) }}</td>
                    <td><p-tag [value]="getStatusLabel(row)" [severity]="row.active ? 'success' : 'secondary'"></p-tag>
                    </td>
                    <td>{{ row.usedCapacity }}</td>
                    <td>
                        <button *ngIf="mode === 'esm'" pButton type="button" icon="pi pi-eye"
                            class="p-button-text p-button-sm mr-1"
                            [pTooltip]="'fileSystem.admin.viewDetails' | translate"
                            (click)="showDetailsDialog(row)"></button>
                        <button pButton type="button" icon="pi pi-pencil" class="p-button-text p-button-sm mr-1"
                            [pTooltip]="'fileSystem.entityAdmin.editFileSystem' | translate"
                            [disabled]="mode === 'ssm' && !canManageFileSystems" (click)="showEditDialog(row)"></button>
                        <button *ngIf="mode === 'esm'" pButton type="button" icon="pi pi-trash"
                            class="p-button-text p-button-sm mr-1 p-button-danger"
                            [pTooltip]="'fileSystem.entityAdmin.deleteFileSystem' | translate"
                            (click)="showDeleteConfirm(row)"></button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage" *ngIf="mode === 'ssm'">
                <tr>
                    <td [attr.colspan]="5" class="text-center p-4 text-500">{{
                        'fileSystem.admin.selectDriveToManageFileSystems' | translate }}</td>
                </tr>
            </ng-template>
        </p-table>

        <div class="mt-3" *ngIf="mode === 'ssm'">
            <p-button [label]="'fileSystem.entityAdmin.createFileSystem' | translate" icon="pi pi-plus"
                [disabled]="!canManageFileSystems" [pTooltip]="createButtonTooltip"
                (onClick)="showCreateDialog()"></p-button>
        </div>
    </div>
</div>

<!-- Create -->
<p-dialog [header]="'fileSystem.entityAdmin.createFileSystemDialogTitle' | translate" [(visible)]="createDialogVisible"
    [modal]="true" [style]="{ width: '450px' }" (onHide)="hideCreateDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label>{{ 'fileSystem.admin.scopeLabel' | translate }}</label>
            <div class="flex flex-column gap-2 mt-2">
                <div class="flex align-items-center">
                    <p-radioButton name="scope" value="personal" [(ngModel)]="newFileSystemScope" [inputId]="'scope-personal'" />
                    <label [for]="'scope-personal'" class="ml-2">{{ 'fileSystem.admin.scopePersonal' | translate }}</label>
                </div>
                <div class="flex align-items-center" *ngIf="canChooseEntityScope">
                    <p-radioButton name="scope" value="entity" [(ngModel)]="newFileSystemScope" [inputId]="'scope-entity'" />
                    <label [for]="'scope-entity'" class="ml-2">{{ 'fileSystem.admin.scopeEntity' | translate }}</label>
                </div>
            </div>
        </div>
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
            <input pInputText [(ngModel)]="newFileSystemName" class="w-full mt-2" />
        </div>
        <div class="field mb-3" *ngIf="mode === 'esm'">
            <label>{{ 'fileSystem.admin.driveName' | translate }}</label>
            <p-dropdown appendTo="body" [options]="driveOptions" [(ngModel)]="newFileSystemDriveId" optionLabel="name"
                optionValue="id" [style]="{ width: '100%' }" [placeholder]="'fileSystem.admin.selectDrive' | translate"
                class="mt-2"></p-dropdown>
        </div>
        <div class="field">
            <label>{{ 'fileSystem.entityAdmin.fileSystemType' | translate }}</label>
            <p-dropdown appendTo="body" [options]="fileSystemTypes" [(ngModel)]="newFileSystemTypeId" optionLabel="name"
                optionValue="id" [style]="{ width: '100%' }" [disabled]="loadingTypes"
                [placeholder]="'fileSystem.admin.selectType' | translate" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideCreateDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.create' | translate" (onClick)="onCreateConfirm()"
            [loading]="creatingFileSystem"></p-button>
    </ng-template>
</p-dialog>

<!-- Edit -->
<p-dialog [header]="'fileSystem.entityAdmin.editFileSystemDialogTitle' | translate" [(visible)]="editDialogVisible"
    [modal]="true" [style]="{ width: '450px' }" (onHide)="hideEditDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid" *ngIf="selectedForEdit">
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
            <input pInputText [(ngModel)]="editFileSystemName" class="w-full mt-2" />
        </div>
        <div class="field">
            <label>{{ 'fileSystem.entityAdmin.fileSystemType' | translate }}</label>
            <p-dropdown [options]="fileSystemTypes" [(ngModel)]="editFileSystemTypeId" optionLabel="name"
                optionValue="id" [style]="{ width: '100%' }" [disabled]="loadingTypes"
                [placeholder]="'fileSystem.admin.selectType' | translate" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideEditDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.save' | translate" (onClick)="onEditSave()"
            [loading]="savingFileSystem"></p-button>
    </ng-template>
</p-dialog>

<!-- Details (ESM) -->
<p-dialog [header]="'fileSystem.entityAdmin.fileSystemDetailsTitle' | translate" [(visible)]="detailsDialogVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideDetailsDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid" *ngIf="selectedForDetails">
        <p *ngIf="detailsLoading">{{ 'fileSystem.companyStorage.loading' | translate }}</p>
        <ng-container *ngIf="!detailsLoading && detailsData">
            <div class="field"><label>{{ 'fileSystem.entityAdmin.entityName' | translate }}</label>
                <p>{{ getEntityName(selectedForDetails) }}</p>
            </div>
            <div class="field"><label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
                <p>{{ detailsData.name }}</p>
            </div>
            <div class="field"><label>{{ 'fileSystem.entityAdmin.fileSystemType' | translate }}</label>
                <p>{{ detailsData.typeName }}</p>
            </div>
            <div class="field"><label>{{ 'fileSystem.admin.driveName' | translate }}</label>
                <p>{{ detailsData.driveName }}</p>
            </div>
            <div class="field"><label>{{ 'fileSystem.entityAdmin.status' | translate }}</label>
                <p>{{ detailsData.active ? ('fileSystem.entityAdminStatus.active' | translate) :
                    ('fileSystem.admin.inactive' | translate) }}</p>
            </div>
            <div class="field"><label>{{ 'fileSystem.entityAdmin.usedCapacity' | translate }}</label>
                <p>{{ detailsData.usedCapacity }}</p>
            </div>
        </ng-container>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" (onClick)="hideDetailsDialog()"></p-button>
    </ng-template>
</p-dialog>

<!-- Delete confirm (ESM) -->
<p-dialog [header]="'fileSystem.entityAdmin.deleteFileSystem' | translate" [(visible)]="deleteConfirmVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideDeleteConfirm()" [draggable]="false" [resizable]="false">
    <p *ngIf="selectedForDelete">{{ 'fileSystem.entityAdmin.confirmDeleteFileSystem' | translate: { name:
        selectedForDelete.name } }}</p>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideDeleteConfirm()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.delete' | translate" severity="danger"
            (onClick)="onDeleteConfirm()" [loading]="deletingFileSystem"></p-button>
    </ng-template>
</p-dialog>

<!-- Recycle bin (ESM) -->
<p-dialog [header]="'fileSystem.companyStorage.recycleBinTitle' | translate" [(visible)]="recycleBinDialogVisible"
    [modal]="true" [style]="{ width: '500px' }" (onHide)="hideRecycleBinDialog()" [draggable]="false"
    [resizable]="false">
    <p class="mb-3">{{ 'fileSystem.companyStorage.recycleBinDescription' | translate }}</p>
    <div class="field mb-3">
        <label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
        <p-dropdown [options]="fileSystems" [(ngModel)]="recycleBinFileSystemId" optionLabel="name" optionValue="id"
            [style]="{ width: '100%' }" [placeholder]="'fileSystem.admin.selectType' | translate"
            (onChange)="onRecycleBinFileSystemSelect()" class="mt-2"></p-dropdown>
    </div>
    <p *ngIf="loadingRecycleBin">{{ 'fileSystem.companyStorage.loading' | translate }}</p>
    <div *ngIf="!loadingRecycleBin && recycleBinContents && recycleBinFileSystemId">
        <p class="mb-2"
            *ngIf="(recycleBinContents.folders?.length || 0) + (recycleBinContents.files?.length || 0) === 0">{{
            'fileSystem.companyStorage.recycleBinEmpty' | translate }}</p>
        <ul *ngIf="(recycleBinContents.folders?.length || 0) + (recycleBinContents.files?.length || 0) > 0"
            class="list-none p-0">
            <li *ngFor="let f of recycleBinContents.folders">{{ f?.folder_Name ?? f?.Folder_Name ?? f?.name ?? '—' }}
            </li>
            <li *ngFor="let f of recycleBinContents.files">{{ f?.file_Name ?? f?.File_Name ?? f?.name ?? '—' }}</li>
        </ul>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.entityAdmin.restoreFileSystem' | translate" icon="pi pi-replay"
            [disabled]="!recycleBinFileSystemId || loadingRecycleBin" (onClick)="onRecycleBinRestoreAll()"
            [loading]="restoringRecycleBin" class="mr-2"></p-button>
        <p-button [label]="'fileSystem.companyStorage.clearRecycleBin' | translate" severity="danger"
            [disabled]="!recycleBinFileSystemId || loadingRecycleBin" (onClick)="onRecycleBinClear()"
            [loading]="clearingRecycleBin"></p-button>
        <p-button [label]="'fileSystem.companyStorage.close' | translate" (onClick)="hideRecycleBinDialog()"></p-button>
    </ng-template>
</p-dialog>