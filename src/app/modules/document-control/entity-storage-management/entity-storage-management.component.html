<div class="entity-admin-view card p-4">
    <div class="entity-admin-top flex flex-col gap-3">
        <a [routerLink]="['/document-control']" class="back-link">
            <i class="pi pi-arrow-left"></i>
            <span>{{ 'fileSystem.backToHome' | translate }}</span>
        </a>

        <div class="page-header">
            <h1 class="page-title">{{ 'fileSystem.entityAdmin.title' | translate }}</h1>
            <p class="page-description">{{ 'fileSystem.entityAdmin.description' | translate }}</p>
        </div>
    </div>

    <div class="kpi-section">
        <h2 class="block-title">{{ 'fileSystem.entityAdmin.overview' | translate }}</h2>
        <div class="kpi-cards">
            <div class="kpi-card kpi-systems">
                <div class="kpi-icon"><i class="pi pi-server"></i></div>
                <div class="kpi-info">
                    <span class="kpi-value">{{ ownedVirtualDrivesCount }}</span>
                    <span class="kpi-label">{{ 'fileSystem.entityAdmin.ownedVirtualDrives' | translate }}</span>
                </div>
            </div>
            <div class="kpi-card kpi-systems">
                <div class="kpi-icon"><i class="pi pi-database"></i></div>
                <div class="kpi-info">
                    <span class="kpi-value">{{ entityFileSystems.length }}</span>
                    <span class="kpi-label">{{ 'fileSystem.entityAdmin.fileSystems' | translate }}</span>
                </div>
            </div>
            <div class="kpi-card kpi-folders">
                <div class="kpi-icon"><i class="pi pi-upload"></i></div>
                <div class="kpi-info">
                    <span class="kpi-value">{{ trafficUploads }}</span>
                    <span class="kpi-label">{{ 'fileSystem.systemAdmin.uploads' | translate }}</span>
                </div>
            </div>
            <div class="kpi-card kpi-permissions">
                <div class="kpi-icon"><i class="pi pi-download"></i></div>
                <div class="kpi-info">
                    <span class="kpi-value">{{ trafficDownloads }}</span>
                    <span class="kpi-label">{{ 'fileSystem.systemAdmin.downloads' | translate }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Virtual Drives Section - Shared Component -->
    <app-virtual-drives-section mode="esm"></app-virtual-drives-section>

    <div class="block-section">
        <h2 class="block-title">{{ 'fileSystem.entityAdmin.synchronization' | translate }}</h2>
        <div class="block-card">
            <p class="mb-3">{{ 'fileSystem.entityAdmin.syncDescription' | translate }}</p>
            <div class="flex flex-wrap gap-2">
                <p-button [label]="'fileSystem.entityAdmin.uploadSync' | translate" icon="pi pi-upload"
                    styleClass="p-button-outlined" (onClick)="showSyncUnderDevDialog()"></p-button>
                <p-button [label]="'fileSystem.entityAdmin.downloadSync' | translate" icon="pi pi-download"
                    styleClass="p-button-outlined" (onClick)="showSyncUnderDevDialog()"></p-button>
                <p-button [label]="'fileSystem.entityAdmin.fullSync' | translate" icon="pi pi-sync"
                    styleClass="p-button-outlined" (onClick)="showSyncUnderDevDialog()"></p-button>
            </div>
        </div>
    </div>

    <div class="block-section">
        <h2 class="block-title">{{ 'fileSystem.entityAdmin.entityStorageSettings' | translate }}</h2>
        <div class="block-card">
            <p class="mb-3">{{ 'fileSystem.entityAdmin.entityStorageSettingsDescription' | translate }}</p>
            <div class="flex flex-col gap-3">
                <div class="flex align-items-center gap-2">
                    <p-checkbox [(ngModel)]="allowShareInternally" [binary]="true"
                        inputId="shareInternally"></p-checkbox>
                    <label for="shareInternally">{{ 'fileSystem.entityAdmin.allowShareInternally' | translate }}</label>
                </div>
                <div class="flex align-items-center gap-2">
                    <p-checkbox [(ngModel)]="allowShareExternally" [binary]="true"
                        inputId="shareExternally"></p-checkbox>
                    <label for="shareExternally">{{ 'fileSystem.entityAdmin.allowShareExternally' | translate }}</label>
                </div>
            </div>
        </div>
    </div>

    <div class="block-section">
        <h2 class="block-title">{{ 'fileSystem.entityAdmin.fileSystemsByEntity' | translate }}</h2>
        <div class="block-card">
            <p class="mb-3 text-500">{{ 'fileSystem.entityAdmin.fileSystemsHostedInDrives' | translate }}</p>
            <div class="mb-3 flex flex-wrap gap-2 align-items-center">
                <p-button [label]="'fileSystem.entityAdmin.createFileSystem' | translate" icon="pi pi-plus"
                    (onClick)="showCreateFileSystemDialog()"></p-button>
                <p-button [label]="'fileSystem.companyStorage.recycleBin' | translate" icon="pi pi-replay"
                    styleClass="p-button-outlined" (onClick)="showRecycleBinDialog()"></p-button>
            </div>
            <p-table [value]="entityFileSystems" [paginator]="false"
                styleClass="p-datatable-sm p-datatable-gridlines entity-admin-table" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>{{ 'fileSystem.entityAdmin.entityName' | translate }}</th>
                        <th>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</th>
                        <th>{{ 'fileSystem.entityAdmin.status' | translate }}</th>
                        <th>{{ 'fileSystem.entityAdmin.usedCapacity' | translate }}</th>
                        <th style="width: 12rem">{{ 'fileSystem.companyStorage.actions' | translate }}</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                    <tr>
                        <td class="cell-entity">{{ getEntityName(row) }}</td>
                        <td>{{ getFileSystemName(row) }}</td>
                        <td><p-tag [value]="getStatusLabel(row)" severity="success"></p-tag></td>
                        <td>{{ row.usedCapacity }}</td>
                        <td>
                            <button pButton type="button" icon="pi pi-eye" class="p-button-text p-button-sm mr-1"
                                [pTooltip]="'fileSystem.admin.viewDetails' | translate"
                                (click)="showFileSystemDetailsDialog(row)"></button>
                            <button pButton type="button" icon="pi pi-pencil" class="p-button-text p-button-sm mr-1"
                                [pTooltip]="'fileSystem.entityAdmin.editFileSystem' | translate"
                                (click)="showEditFileSystemDialog(row)"></button>
                            <button pButton type="button" icon="pi pi-trash"
                                class="p-button-text p-button-sm mr-1 p-button-danger"
                                [pTooltip]="'fileSystem.entityAdmin.deleteFileSystem' | translate"
                                (click)="onDeleteFileSystem(row)"></button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>

    <div class="block-section">
        <h2 class="block-title">{{ 'fileSystem.entityAdmin.folderStructure' | translate }}</h2>
        <div class="block-card">
            <div class="tree-wrap">
                <p-tree [value]="folderStructure" styleClass="w-full border-0 entity-tree"
                    selectionMode="single"></p-tree>
            </div>
        </div>
    </div>

    <div class="block-section">
        <h2 class="block-title">{{ 'fileSystem.entityAdmin.permissions' | translate }}</h2>
        <div class="block-card">
            <p class="mb-3 text-500">{{ 'fileSystem.entityAdmin.sharingExpiryDescription' | translate }}</p>
            <div class="mb-3">
                <p-button [label]="'fileSystem.entityAdmin.addPermission' | translate" icon="pi pi-plus"
                    (onClick)="showAddPermissionDialog()"></p-button>
            </div>
            <p-table [value]="permissions" [paginator]="false"
                styleClass="p-datatable-sm p-datatable-gridlines entity-admin-table" responsiveLayout="scroll">
                <ng-template pTemplate="header">
                    <tr>
                        <th>{{ 'fileSystem.entityAdmin.role' | translate }}</th>
                        <th>{{ 'fileSystem.entityAdmin.folderPath' | translate }}</th>
                        <th>{{ 'fileSystem.entityAdmin.access' | translate }}</th>
                        <th style="width: 10rem">{{ 'fileSystem.companyStorage.actions' | translate }}</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                    <tr>
                        <td class="cell-role">{{ getRoleLabel(row) }}</td>
                        <td><code class="path-code">{{ row.folderPath }}</code></td>
                        <td><p-tag [value]="getAccessLabel(row)" severity="info"></p-tag></td>
                        <td>
                            <button pButton type="button" icon="pi pi-pencil" class="p-button-text p-button-sm mr-1"
                                [pTooltip]="'fileSystem.entityAdmin.editPermission' | translate"
                                (click)="showEditPermissionDialog(row)"></button>
                            <button pButton type="button" icon="pi pi-trash"
                                class="p-button-text p-button-sm p-button-danger"
                                [pTooltip]="'fileSystem.entityAdmin.deletePermission' | translate"
                                (click)="onDeletePermission(row)"></button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>

<p-dialog [header]="'fileSystem.entityAdmin.createFileSystemDialogTitle' | translate"
    [(visible)]="createFileSystemDialogVisible" [modal]="true" [style]="{ width: '450px' }"
    (onHide)="hideCreateFileSystemDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
            <input pInputText [(ngModel)]="newFileSystemName" class="w-full mt-2" />
        </div>
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.entityName' | translate }}</label>
            <p-dropdown [options]="entityOptions" [(ngModel)]="newFileSystemEntityKey" optionLabel="label"
                optionValue="value" [style]="{ width: '100%' }" class="mt-2"></p-dropdown>
        </div>
        <div class="field">
            <label>{{ 'fileSystem.entityAdmin.fileSystemType' | translate }}</label>
            <p-dropdown [options]="fileSystemTypeOptions" [(ngModel)]="newFileSystemTypeKey" optionLabel="label"
                optionValue="value" [style]="{ width: '100%' }" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideCreateFileSystemDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.create' | translate"
            (onClick)="onCreateFileSystemConfirm()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.entityAdmin.fileSystemDetailsTitle' | translate"
    [(visible)]="fileSystemDetailsDialogVisible" [modal]="true" [style]="{ width: '400px' }"
    (onHide)="hideFileSystemDetailsDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid" *ngIf="selectedFileSystemForDetails">
        <div class="field"><label>{{ 'fileSystem.entityAdmin.entityName' | translate }}</label>
            <p>{{ getEntityName(selectedFileSystemForDetails) }}</p>
        </div>
        <div class="field"><label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
            <p>{{ getFileSystemName(selectedFileSystemForDetails) }}</p>
        </div>
        <div class="field"><label>{{ 'fileSystem.entityAdmin.status' | translate }}</label>
            <p>{{ getStatusLabel(selectedFileSystemForDetails) }}</p>
        </div>
        <div class="field"><label>{{ 'fileSystem.entityAdmin.usedCapacity' | translate }}</label>
            <p>{{ selectedFileSystemForDetails.usedCapacity }}</p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate"
            (onClick)="hideFileSystemDetailsDialog()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.entityAdmin.editFileSystemDialogTitle' | translate"
    [(visible)]="editFileSystemDialogVisible" [modal]="true" [style]="{ width: '400px' }"
    (onHide)="hideEditFileSystemDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field">
            <label>{{ 'fileSystem.entityAdmin.fileSystemName' | translate }}</label>
            <input pInputText [(ngModel)]="editFileSystemName" class="w-full mt-2" />
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideEditFileSystemDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.save' | translate" (onClick)="onEditFileSystemSave()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.entityAdmin.addPermissionDialogTitle' | translate"
    [(visible)]="addPermissionDialogVisible" [modal]="true" [style]="{ width: '450px' }"
    (onHide)="hideAddPermissionDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.role' | translate }}</label>
            <p-dropdown [options]="roleOptions" [(ngModel)]="newPermissionRoleKey" optionLabel="label"
                optionValue="value" [style]="{ width: '100%' }" class="mt-2"></p-dropdown>
        </div>
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.folderPath' | translate }}</label>
            <input pInputText [(ngModel)]="newPermissionPath" class="w-full mt-2" />
        </div>
        <div class="field">
            <label>{{ 'fileSystem.entityAdmin.access' | translate }}</label>
            <p-dropdown [options]="accessOptions" [(ngModel)]="newPermissionAccessKey" optionLabel="label"
                optionValue="value" [style]="{ width: '100%' }" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideAddPermissionDialog()"></p-button>
        <p-button [label]="'fileSystem.entityAdmin.addPermission' | translate"
            (onClick)="onAddPermissionConfirm()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.entityAdmin.editPermissionDialogTitle' | translate"
    [(visible)]="editPermissionDialogVisible" [modal]="true" [style]="{ width: '450px' }"
    (onHide)="hideEditPermissionDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.role' | translate }}</label>
            <input pInputText [(ngModel)]="editPermissionRoleKey" class="w-full mt-2" readonly />
        </div>
        <div class="field mb-3">
            <label>{{ 'fileSystem.entityAdmin.folderPath' | translate }}</label>
            <input pInputText [(ngModel)]="editPermissionPath" class="w-full mt-2" />
        </div>
        <div class="field">
            <label>{{ 'fileSystem.entityAdmin.access' | translate }}</label>
            <p-dropdown [options]="accessOptions" [(ngModel)]="editPermissionAccessKey" optionLabel="label"
                optionValue="value" [style]="{ width: '100%' }" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideEditPermissionDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.save' | translate" (onClick)="onEditPermissionSave()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.recycleBinTitle' | translate" [(visible)]="recycleBinDialogVisible"
    [modal]="true" [style]="{ width: '450px' }" (onHide)="hideRecycleBinDialog()" [draggable]="false"
    [resizable]="false">
    <p>{{ 'fileSystem.companyStorage.recycleBinDescription' | translate }}</p>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" (onClick)="hideRecycleBinDialog()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.admin.syncUnderDevelopmentTitle' | translate" [(visible)]="syncUnderDevDialogVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideSyncUnderDevDialog()" [draggable]="false"
    [resizable]="false">
    <p>{{ 'fileSystem.admin.syncUnderDevelopmentMessage' | translate }}</p>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate"
            (onClick)="hideSyncUnderDevDialog()"></p-button>
    </ng-template>
</p-dialog>