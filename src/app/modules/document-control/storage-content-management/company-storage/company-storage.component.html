<div class="company-storage-view card">
    <div class="company-storage-top flex flex-col gap-3">
        <a routerLink="/document-control/storage-content-management" class="back-link mb-3">
            <i class="pi pi-arrow-left mr-2"></i>{{ 'fileSystem.backToHome' | translate }}
        </a>
        <div class="section-header">
            <h2 class="section-title">{{ 'fileSystem.companyStorageView.title' | translate }}</h2>
            <p class="section-description">{{ 'fileSystem.companyStorageView.description' | translate }}</p>
        </div>
    </div>
    <div class="flex flex-wrap gap-3  mb-3 justify-content-center">
        <div class="field">
            <label class="block mb-1">{{ 'fileSystem.companyStorageView.selectDrive' | translate }}</label>
            <p-dropdown [options]="entityDriveOptions" [(ngModel)]="selectedDriveId" optionLabel="name" optionValue="id"
                [style]="{ width: '240px' }" [disabled]="loadingDrives"
                [placeholder]="loadingDrives ? ('fileSystem.companyStorage.loading' | translate) : ('fileSystem.companyStorageView.selectDrive' | translate)"
                (onChange)="onDriveSelected()"></p-dropdown>
        </div>
        <div class="field">
            <label class="block mb-1">{{ 'fileSystem.companyStorageView.selectFileSystem' | translate }}</label>
            <p-dropdown [options]="fileSystemOptionsInDrive" [(ngModel)]="selectedFileSystemId" optionLabel="name"
                optionValue="id" [style]="{ width: '240px' }" [disabled]="!selectedDriveId || loadingFileSystemsInDrive"
                [placeholder]="loadingFileSystemsInDrive ? ('fileSystem.companyStorage.loading' | translate) : ('fileSystem.companyStorageView.selectFileSystem' | translate)"
                (onChange)="onFileSystemSelected()"></p-dropdown>
        </div>
    </div>

    <div class="content-card p-4 mb-3" *ngIf="!selectedFileSystemId">
        <p class="text-500 m-0">{{ 'fileSystem.companyStorageView.selectDriveAndFileSystem' | translate }}</p>
    </div>

    <div class="toolbar-wrap mb-3" *ngIf="selectedFileSystemId">
        <div class="content-card">
            <div class="content-card-body py-2">
                <p-toolbar styleClass="p-toolbar-flat border-0">
                    <div class="p-toolbar-group-start gap-3">
                        <p-button [label]="'fileSystem.companyStorage.upload' | translate" icon="pi pi-upload"
                            (onClick)="showUploadDialog()"></p-button>
                        <p-button [label]="'fileSystem.companyStorage.newFolder' | translate" icon="pi pi-folder-plus"
                            styleClass="p-button-secondary" (onClick)="showNewFolderDialog()"></p-button>
                        <p-button [label]="'fileSystem.companyStorage.download' | translate" icon="pi pi-download"
                            styleClass="p-button-secondary" (onClick)="showDownloadProgressDialog()"></p-button>
                        <p-button [label]="'fileSystem.companyStorage.delete' | translate" icon="pi pi-trash"
                            styleClass="p-button-secondary" [disabled]="true"></p-button>
                        <p-button [label]="'fileSystem.companyStorage.recycleBin' | translate" icon="pi pi-replay"
                            styleClass="p-button-secondary" (onClick)="showRecycleBinDialog()"></p-button>
                        <p-button [label]="'fileSystem.companyStorage.allocateFile' | translate" icon="pi pi-link"
                            styleClass="p-button-secondary" (onClick)="showAllocateFileDialog()"></p-button>
                    </div>
                </p-toolbar>
            </div>
        </div>
    </div>

    <!-- Folder Management Component -->
    <app-folder-management *ngIf="selectedFileSystemId" [fileSystemId]="selectedFileSystemId"></app-folder-management>

    <p-menu #folderRowMenu [model]="folderMenuItems" [popup]="true" [appendTo]="'body'"></p-menu>
    <p-menu #fileRowMenu [model]="fileMenuItems" [popup]="true" [appendTo]="'body'"></p-menu>
</div>

<p-dialog [header]="'fileSystem.companyStorage.newFolderDialogTitle' | translate" [(visible)]="newFolderDialogVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideNewFolderDialog()" [draggable]="false"
    [resizable]="false">
    <div class="p-fluid">
        <label for="newFolderName">{{ 'fileSystem.companyStorage.folderName' | translate }}</label>
        <input pInputText id="newFolderName" [(ngModel)]="newFolderName" class="w-full mt-2" />
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideNewFolderDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.create' | translate" (onClick)="createFolder()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.renameFolderDialogTitle' | translate"
    [(visible)]="renameFolderDialogVisible" [modal]="true" [style]="{ width: '400px' }" (onHide)="hideRenameDialog()"
    [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <label for="renameFolderName">{{ 'fileSystem.companyStorage.folderName' | translate }}</label>
        <input pInputText id="renameFolderName" [(ngModel)]="renameFolderName" class="w-full mt-2" />
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideRenameDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.save' | translate" (onClick)="saveRenameFolder()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.uploadDialogTitle' | translate" [(visible)]="uploadDialogVisible"
    [modal]="true" [style]="{ width: '420px' }" (onHide)="hideUploadDialog()" [draggable]="false" [resizable]="false"
    styleClass="upload-dialog">
    <div class="p-fluid">
        <div class="field mb-3">
            <label for="newFileName">{{ 'fileSystem.companyStorage.fileNameLabel' | translate }}</label>
            <input pInputText id="newFileName" [(ngModel)]="newFileName" class="w-full mt-2" />
        </div>
        <div class="field">
            <label for="newFileType">{{ 'fileSystem.companyStorage.fileTypeLabel' | translate }}</label>
            <p-dropdown id="newFileType" [options]="fileTypeOptions" [(ngModel)]="newFileType" optionLabel="label"
                optionValue="value" [style]="{ width: '100%' }" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideUploadDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.uploadButton' | translate" (onClick)="uploadFile()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.moveFolderDialogTitle' | translate" [(visible)]="moveFolderDialogVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideMoveFolderDialog()" [draggable]="false"
    [resizable]="false">
    <p class="mb-3">{{ 'fileSystem.companyStorage.moveFolderDestinationHint' | translate }}</p>
    <p-tree [value]="folderTree" selectionMode="single" [(selection)]="moveDestinationNode" styleClass="w-full border-0"
        [metaKeySelection]="false"></p-tree>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideMoveFolderDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.move' | translate" (onClick)="onMoveFolderConfirm()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.moveFileDialogTitle' | translate" [(visible)]="moveFileDialogVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideMoveFileDialog()" [draggable]="false" [resizable]="false">
    <p class="mb-3" *ngIf="fileForMove">{{ 'fileSystem.companyStorage.moveFileDestinationHint' | translate }}: {{
        fileForMove.name }}</p>
    <p-tree [value]="folderTree" selectionMode="single" [(selection)]="moveDestinationNode" styleClass="w-full border-0"
        [metaKeySelection]="false"></p-tree>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideMoveFileDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.move' | translate" (onClick)="onMoveFileConfirm()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.fileDetailsTitle' | translate" [(visible)]="fileDetailsDialogVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideFileDetailsDialog()" [draggable]="false"
    [resizable]="false">
    <div class="p-fluid" *ngIf="fileForDetails">
        <div class="field"><label>{{ 'fileSystem.companyStorage.fileName' | translate }}</label>
            <p>{{ fileForDetails.name }}</p>
        </div>
        <div class="field"><label>{{ 'fileSystem.companyStorage.type' | translate }}</label>
            <p>{{ fileForDetails.type }}</p>
        </div>
        <div class="field"><label>{{ 'fileSystem.companyStorage.size' | translate }}</label>
            <p>{{ fileForDetails.size }}</p>
        </div>
        <div class="field"><label>{{ 'fileSystem.companyStorage.modified' | translate }}</label>
            <p>{{ fileForDetails.modified }}</p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate"
            (onClick)="hideFileDetailsDialog()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.folderDetailsTitle' | translate" [(visible)]="folderDetailsDialogVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideFolderDetailsDialog()" [draggable]="false"
    [resizable]="false">
    <div class="p-fluid" *ngIf="folderNodeForDetails">
        <div class="field"><label>{{ 'fileSystem.companyStorage.folderName' | translate }}</label>
            <p>{{ folderNodeForDetails.label }}</p>
        </div>
        <div class="field"><label>{{ 'fileSystem.companyStorage.folderId' | translate }}</label>
            <p>{{ folderNodeForDetails.data?.id }}</p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate"
            (onClick)="hideFolderDetailsDialog()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.editFileDialogTitle' | translate" [(visible)]="editFileDialogVisible"
    [modal]="true" [style]="{ width: '400px' }" (onHide)="hideEditFileDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label for="editFileName">{{ 'fileSystem.companyStorage.fileNameLabel' | translate }}</label>
            <input pInputText id="editFileName" [(ngModel)]="editFileName" class="w-full mt-2" />
        </div>
        <div class="field">
            <label for="editFileType">{{ 'fileSystem.companyStorage.fileTypeLabel' | translate }}</label>
            <p-dropdown id="editFileType" [options]="fileTypeOptions" [(ngModel)]="editFileType" optionLabel="label"
                optionValue="value" [style]="{ width: '100%' }" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideEditFileDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.save' | translate" (onClick)="onEditFileSave()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.recycleBinTitle' | translate" [(visible)]="recycleBinDialogVisible"
    [modal]="true" [style]="{ width: '500px' }" (onHide)="hideRecycleBinDialog()" [draggable]="false"
    [resizable]="false">
    <p class="mb-3">{{ 'fileSystem.companyStorage.recycleBinDescription' | translate }}</p>
    <p-table [value]="recycleBinItems" [paginator]="false" styleClass="p-datatable-sm p-datatable-gridlines"
        responsiveLayout="scroll">
        <ng-template pTemplate="header">
            <tr>
                <th>{{ 'fileSystem.companyStorage.fileName' | translate }}</th>
                <th>{{ 'fileSystem.companyStorage.itemType' | translate }}</th>
                <th style="width: 6rem"></th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
            <tr>
                <td>{{ row.name }}</td>
                <td>{{ (row.isFolder ? 'fileSystem.companyStorage.typeFolder' : 'fileSystem.companyStorage.typeFile') |
                    translate }}</td>
                <td>
                    <button pButton type="button" icon="pi pi-replay" class="p-button-text p-button-sm"
                        (click)="onRecycleBinRestore()"
                        [pTooltip]="'fileSystem.companyStorage.restore' | translate"></button>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="3" class="text-center p-3 text-500">{{ 'fileSystem.companyStorage.recycleBinEmpty' |
                    translate }}</td>
            </tr>
        </ng-template>
    </p-table>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideRecycleBinDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.clearRecycleBin' | translate" icon="pi pi-trash"
            class="p-button-danger" (onClick)="onRecycleBinClear()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.allocateFileDialogTitle' | translate"
    [(visible)]="allocateFileDialogVisible" [modal]="true" [style]="{ width: '420px' }"
    (onHide)="hideAllocateFileDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label for="allocateFileId">{{ 'fileSystem.companyStorage.fileId' | translate }}</label>
            <input pInputText id="allocateFileId" [(ngModel)]="allocateFileId" class="w-full mt-2" />
        </div>
        <div class="field mb-3">
            <label for="allocateFolderId">{{ 'fileSystem.companyStorage.destinationFolder' | translate }}</label>
            <input pInputText id="allocateFolderId" [(ngModel)]="allocateFolderId" class="w-full mt-2" />
        </div>
        <div class="field">
            <label for="allocateType">{{ 'fileSystem.companyStorage.allocationType' | translate }}</label>
            <p-dropdown id="allocateType" [options]="allocationTypeOptions" [(ngModel)]="allocateType"
                optionLabel="label" optionValue="value" [style]="{ width: '100%' }" class="mt-2"></p-dropdown>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideAllocateFileDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.assign' | translate"
            (onClick)="onAllocateFileConfirm()"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'fileSystem.companyStorage.downloadProgressTitle' | translate"
    [(visible)]="downloadProgressDialogVisible" [modal]="true" [style]="{ width: '400px' }" [closable]="false"
    [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <p class="mb-2">{{ 'fileSystem.companyStorage.downloading' | translate }}</p>
        <p-progressBar [value]="downloadProgressValue" [showValue]="true"></p-progressBar>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate"
            (onClick)="onDownloadProgressComplete()"></p-button>
    </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>