<div class="folder-management-container card" *ngIf="fileSystemId > 0">
    <div class="toolbar mb-3">
        <div class="flex align-items-center gap-2">
            <p-button [label]="'fileSystem.folderManagement.createFolder' | translate" icon="pi pi-plus"
                (onClick)="showCreateFolderDialog()"></p-button>
            <p-button [label]="'fileSystem.folderManagement.restoreDeletedFolders' | translate" icon="pi pi-replay"
                styleClass="p-button-outlined" (onClick)="showRestoreDeletedFoldersDialog()"></p-button>
        </div>
    </div>

    <div class="folder-layout flex gap-3">
        <!-- Left Panel: Folder Tree -->
        <div class="tree-panel flex-1">
            <div class="card">
                <div class="card-header mb-2">
                    <h3 class="m-0">{{ 'fileSystem.folderManagement.folders' | translate }}</h3>
                </div>
                <div class="card-body">
                    <p-tree [value]="folderTreeNodes" selectionMode="single" [(selection)]="selectedFolderNode"
                        (onNodeSelect)="onFolderNodeSelect($event)" styleClass="w-full border-0 folder-tree">
                        <ng-template pTemplate="default" let-node>
                            <div class="tree-node-row flex align-items-center justify-content-between">
                                <span class="tree-node-label flex-1">{{ node.label }}</span>
                                <span class="tree-node-actions">
                                    <button pButton type="button" icon="pi pi-ellipsis-v"
                                        class="p-button-rounded p-button-text p-button-plain p-button-sm"
                                        (click)="openFolderMenu(folderRowMenu, node, $event)"
                                        [pTooltip]="'fileSystem.folderManagement.actions' | translate"></button>
                                </span>
                            </div>
                        </ng-template>
                    </p-tree>
                    <p-menu #folderRowMenu [model]="folderMenuItems" [popup]="true" [appendTo]="'body'"></p-menu>
                    <p-menu #fileRowMenu [model]="fileMenuItems" [popup]="true" [appendTo]="'body'"></p-menu>
                </div>
            </div>
        </div>

        <!-- Right Panel: Folder Contents Table -->
        <div class="contents-panel flex-2">
            <div class="card">
                <div class="card-header mb-2">
                    <h3 class="m-0">{{ 'fileSystem.folderManagement.contents' | translate }}</h3>
                </div>
                <div class="card-body p-0">
                    <p-table #contentsTable [value]="folderContentsTableValue" [paginator]="false"
                        styleClass="p-datatable-sm p-datatable-gridlines p-datatable-striped" responsiveLayout="scroll"
                        [globalFilterFields]="['name']">
                        <ng-template pTemplate="caption">
                            <div class="flex align-items-center justify-content-between mb-2">
                                <span class="p-input-icon-left flex-1 max-w-md">
                                    <i class="pi pi-search"></i>
                                    <input pInputText type="text"
                                        (input)="contentsTable.filterGlobal($any($event.target).value, 'contains')"
                                        [placeholder]="'fileSystem.folderManagement.searchPlaceholder' | translate"
                                        class="w-full" />
                                </span>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 3rem"></th>
                                <th style="width: 20rem">{{ 'fileSystem.folderManagement.name' | translate }}</th>
                                <th style="width: 8rem">{{ 'fileSystem.folderManagement.type' | translate }}</th>
                                <th style="width: 10rem">{{ 'fileSystem.folderManagement.size' | translate }}</th>
                                <th style="width: 12rem">{{ 'fileSystem.folderManagement.modified' | translate }}</th>
                                <th style="width: 4rem">{{ 'fileSystem.folderManagement.actions' | translate }}</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-row>
                            <tr [class.cursor-pointer]="row.isFolder" (dblclick)="onContentRowDoubleClick(row)">
                                <td>
                                    <ng-container *ngIf="tableLoadingSpinner; else normalIcon">
                                        <p-skeleton height="1.5rem" width="1.5rem" borderRadius="4px"></p-skeleton>
                                    </ng-container>
                                    <ng-template #normalIcon>
                                        <i [class]="row.isFolder ? 'pi pi-folder' : 'pi pi-file'"
                                            class="file-type-icon"></i>
                                    </ng-template>
                                </td>
                                <td>
                                    <ng-container *ngIf="tableLoadingSpinner; else normalName">
                                        <p-skeleton height="1.25rem" width="14rem"></p-skeleton>
                                    </ng-container>
                                    <ng-template #normalName>
                                        <span class="font-semibold">{{ getContentRowName(row) }}</span>
                                    </ng-template>
                                </td>
                                <td>
                                    <ng-container *ngIf="tableLoadingSpinner; else normalType">
                                        <p-skeleton height="1.25rem" width="6rem"></p-skeleton>
                                    </ng-container>
                                    <ng-template #normalType>
                                        <span>{{ getContentRowType(row) }}</span>
                                    </ng-template>
                                </td>
                                <td>
                                    <ng-container *ngIf="tableLoadingSpinner; else normalSize">
                                        <p-skeleton height="1.25rem" width="5rem"></p-skeleton>
                                    </ng-container>
                                    <ng-template #normalSize>
                                        <span>{{ row.size || '—' }}</span>
                                    </ng-template>
                                </td>
                                <td>
                                    <ng-container *ngIf="tableLoadingSpinner; else normalModified">
                                        <p-skeleton height="1.25rem" width="8rem"></p-skeleton>
                                    </ng-container>
                                    <ng-template #normalModified>
                                        <span>{{ row.modified || '—' }}</span>
                                    </ng-template>
                                </td>
                                <td>
                                    <ng-container *ngIf="tableLoadingSpinner; else normalActions">
                                        <p-skeleton height="1.5rem" width="2rem" borderRadius="4px"></p-skeleton>
                                    </ng-container>
                                    <ng-template #normalActions>
                                        <button *ngIf="!row.isFolder" pButton type="button" icon="pi pi-ellipsis-v"
                                            class="p-button-rounded p-button-text p-button-plain p-button-sm"
                                            (click)="openFileMenu(fileRowMenu, row, $event)"
                                            [pTooltip]="'fileSystem.folderManagement.actions' | translate">
                                        </button>
                                    </ng-template>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="6" class="text-center">
                                    {{ 'fileSystem.folderManagement.noContents' | translate }}
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card" *ngIf="fileSystemId <= 0">
    <p class="text-500 m-0">{{ 'fileSystem.folderManagement.selectFileSystem' | translate }}</p>
</div>

<!-- Upload Files Dialog -->
<p-dialog [header]="'fileSystem.folderManagement.uploadDialogTitle' | translate" [(visible)]="uploadDialogVisible"
    [modal]="true" [style]="{ width: '700px' }" (onHide)="hideUploadDialog()" [draggable]="false" [resizable]="false"
    [closable]="!uploadInProgress">
    <div class="p-fluid">
        <div class="field mb-3">
            <label class="block mb-2 font-semibold">{{ 'fileSystem.folderManagement.upload' | translate }}</label>
            <!-- Hidden file input -->
            <input #fileInput type="file" multiple (change)="onFilesSelected($event)" accept="*/*"
                style="display: none;" />
            <!-- Drop zone with drag and drop support -->
            <div class="file-drop-zone border-2 border-dashed border-round p-4 text-center"
                [class.drag-over]="isDragOver" [class.disabled]="uploadInProgress" (dragover)="onDragOver($event)"
                (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
                <i class="pi pi-cloud-upload text-4xl text-primary mb-3 block"></i>
                <p class="text-lg font-semibold mb-2">
                    {{ 'fileSystem.folderManagement.dropFilesHere' | translate }}
                </p>
                <p class="text-500 mb-3">
                    {{ 'fileSystem.folderManagement.or' | translate }}
                </p>
                <!-- Custom button to trigger file selection -->
                <p-button [label]="'fileSystem.folderManagement.selectFiles' | translate" icon="pi pi-file"
                    styleClass="p-button-outlined" (onClick)="triggerFileInput()" [disabled]="uploadInProgress">
                </p-button>
            </div>
            <small class="text-500 block mt-2">{{ 'fileSystem.folderManagement.selectFilesToUpload' | translate
                }}</small>
        </div>

        <!-- Selected Files List -->
        <div *ngIf="selectedFiles.length > 0" class="mb-3">
            <label class="block mb-2 font-semibold">{{ 'fileSystem.folderManagement.selectedFiles' | translate
                }}</label>
            <div class="selected-files-list border-1 surface-border border-round p-3"
                style="max-height: 200px; overflow-y: auto;">
                <div *ngFor="let file of selectedFiles; let i = index"
                    class="flex align-items-center justify-content-between mb-2 pb-2 border-bottom-1 surface-border"
                    [class.border-bottom-0]="i === selectedFiles.length - 1">
                    <div class="flex align-items-center gap-2 flex-1">
                        <!-- File icon or status icon -->
                        <i *ngIf="getFileUploadStatus(file.name) === 'pending'" class="pi pi-file text-primary"></i>
                        <i *ngIf="getFileUploadStatus(file.name) === 'uploading'"
                            class="pi pi-spin pi-spinner text-primary"></i>
                        <i *ngIf="getFileUploadStatus(file.name) === 'completed'"
                            class="pi pi-check-circle text-green-500"></i>
                        <i *ngIf="getFileUploadStatus(file.name) === 'error'"
                            class="pi pi-times-circle text-red-500"></i>
                        <span class="text-sm flex-1" [title]="file.name"
                            [class.text-green-600]="getFileUploadStatus(file.name) === 'completed'"
                            [class.text-red-600]="getFileUploadStatus(file.name) === 'error'">
                            {{ file.name }}
                        </span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="text-xs text-500">{{ formatFileSize(file.size) }}</span>
                        <!-- Remove button - hide when upload is in progress or file is completed -->
                        <button
                            *ngIf="!uploadInProgress && getFileUploadStatus(file.name) !== 'uploading' && getFileUploadStatus(file.name) !== 'completed'"
                            type="button" class="p-button p-button-text p-button-rounded p-button-danger p-button-sm"
                            (click)="removeFile(file)" [title]="'fileSystem.folderManagement.removeFile' | translate">
                            <i class="pi pi-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <small class="text-500 block mt-2">
                {{ selectedFiles.length }} {{ 'fileSystem.folderManagement.filesSelected' | translate }}
            </small>
        </div>

        <!-- Upload Progress -->
        <div *ngIf="uploadInProgress" class="field mb-3">
            <label class="block mb-2 font-semibold">{{ 'fileSystem.folderManagement.uploadProgress' | translate
                }}</label>
            <p-progressBar [value]="uploadProgressPercent" [showValue]="true" styleClass="mt-2"></p-progressBar>
            <small class="text-500 block mt-1">{{ uploadProgressPercent }}% {{ 'fileSystem.folderManagement.complete' |
                translate }}</small>
        </div>

        <!-- Error Message -->
        <div *ngIf="uploadError" class="p-3 mb-3 surface-100 border-round border-1 border-red-300">
            <div class="flex align-items-center gap-2 text-red-500">
                <i class="pi pi-exclamation-triangle"></i>
                <span>{{ uploadError }}</span>
            </div>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideUploadDialog()" [disabled]="uploadInProgress"></p-button>
        <p-button [label]="'fileSystem.folderManagement.upload' | translate" icon="pi pi-upload"
            (onClick)="onUploadConfirm()" [disabled]="uploadInProgress || selectedFiles.length === 0"></p-button>
    </ng-template>
</p-dialog>

<!-- Create Folder Dialog -->
<p-dialog [header]="'fileSystem.folderManagement.createFolderDialogTitle' | translate"
    [(visible)]="createFolderDialogVisible" [modal]="true" [style]="{ width: '400px' }"
    (onHide)="hideCreateFolderDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label for="newFolderName">{{ 'fileSystem.folderManagement.folderName' | translate }}</label>
            <input pInputText id="newFolderName" [(ngModel)]="newFolderName" class="w-full mt-2" />
        </div>
        <div class="field">
            <label>{{ 'fileSystem.folderManagement.parentFolder' | translate }}</label>
            <p class="text-500 mt-2">
                {{ currentFolderId === 0 ? ('fileSystem.folderManagement.rootFolder' | translate) :
                ('fileSystem.folderManagement.currentFolder' | translate) }}
            </p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideCreateFolderDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.create' | translate"
            (onClick)="onCreateFolderConfirm()"></p-button>
    </ng-template>
</p-dialog>

<!-- Rename Folder Dialog -->
<p-dialog [header]="'fileSystem.folderManagement.renameFolderDialogTitle' | translate"
    [(visible)]="renameFolderDialogVisible" [modal]="true" [style]="{ width: '400px' }"
    (onHide)="hideRenameFolderDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field">
            <label for="renameFolderName">{{ 'fileSystem.folderManagement.newFolderName' | translate }}</label>
            <input pInputText id="renameFolderName" [(ngModel)]="renameFolderName" class="w-full mt-2" />
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideRenameFolderDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.save' | translate" (onClick)="onRenameFolderSave()"></p-button>
    </ng-template>
</p-dialog>

<!-- Move Folder Dialog -->
<p-dialog [header]="'fileSystem.folderManagement.moveFolderDialogTitle' | translate"
    [(visible)]="moveFolderDialogVisible" [modal]="true" [style]="{ width: '500px' }" (onHide)="hideMoveFolderDialog()"
    [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label>{{ 'fileSystem.folderManagement.selectDestination' | translate }}</label>
            <p-tree [value]="folderTreeNodes" selectionMode="single" [(selection)]="moveDestinationNode"
                styleClass="w-full border-0 mt-2">
            </p-tree>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideMoveFolderDialog()"></p-button>
        <p-button [label]="'fileSystem.folderManagement.move' | translate" (onClick)="onMoveFolderConfirm()"
            [disabled]="!moveDestinationNode"></p-button>
    </ng-template>
</p-dialog>

<!-- Delete Folder Confirmation Dialog -->
<p-dialog [header]="'fileSystem.folderManagement.deleteFolder' | translate" [(visible)]="deleteFolderConfirmVisible"
    [modal]="true" [style]="{ width: '450px' }" (onHide)="hideDeleteFolderConfirm()" [draggable]="false"
    [resizable]="false">
    <div class="flex align-items-center gap-3 mb-3">
        <i class="pi pi-exclamation-triangle text-2xl text-yellow-500"></i>
        <p class="mb-0" *ngIf="selectedFolderForDelete">
            {{ 'fileSystem.folderManagement.confirmDeleteFolder' | translate: { name:
            selectedFolderForDelete.data.folderName } }}
        </p>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideDeleteFolderConfirm()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.delete' | translate" severity="danger"
            (onClick)="onDeleteFolderConfirm()"></p-button>
    </ng-template>
</p-dialog>

<!-- Restore Deleted Folders Dialog -->
<p-dialog [header]="'fileSystem.folderManagement.restoreDeletedFoldersDialogTitle' | translate"
    [(visible)]="restoreDeletedFoldersDialogVisible" [modal]="true" [style]="{ width: '500px' }"
    (onHide)="hideRestoreDeletedFoldersDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <p class="mb-3">{{ 'fileSystem.folderManagement.restoreDeletedFoldersDescription' | translate }}</p>
        <div *ngIf="deletedFolders.length === 0" class="text-center text-500 py-3">
            {{ 'fileSystem.folderManagement.noDeletedFolders' | translate }}
        </div>
        <div *ngIf="deletedFolders.length > 0">
            <p-table [value]="deletedFolders" [paginator]="false" selectionMode="multiple"
                [(selection)]="selectedFoldersToRestore" dataKey="folder_ID">
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th>{{ 'fileSystem.folderManagement.folderName' | translate }}</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-folder>
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="folder"></p-tableCheckbox>
                        </td>
                        <td>{{ folder.folder_Name || folder.Folder_Name }}</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideRestoreDeletedFoldersDialog()"></p-button>
        <p-button [label]="'fileSystem.folderManagement.restore' | translate"
            (onClick)="onRestoreDeletedFoldersConfirm()" [disabled]="selectedFoldersToRestore.length === 0"></p-button>
    </ng-template>
</p-dialog>

<!-- File Details Dialog -->
<p-dialog [header]="'fileSystem.folderManagement.fileDetailsDialogTitle' | translate"
    [(visible)]="fileDetailsDialogVisible" [modal]="true" [style]="{ width: '500px' }"
    (onHide)="hideFileDetailsDialog()" [draggable]="false" [resizable]="false">
    <div class="p-fluid" *ngIf="fileDetailsLoading">
        <div class="flex align-items-center justify-content-center py-5">
            <i class="pi pi-spin pi-spinner text-2xl"></i>
        </div>
    </div>
    <div class="p-fluid" *ngIf="!fileDetailsLoading && fileDetails">
        <div class="field mb-3">
            <label class="font-semibold">{{ 'fileSystem.folderManagement.fileName' | translate }}</label>
            <p class="mt-2 mb-0">{{ fileDetails?.file_Name || fileDetails?.file_name || fileDetails?.name ||
                selectedFileForDetails?.name || '—' }}</p>
        </div>
        <div class="field mb-3">
            <label class="font-semibold">{{ 'fileSystem.folderManagement.fileType' | translate }}</label>
            <p class="mt-2 mb-0">{{ fileDetails?.file_Type || fileDetails?.file_type || fileDetails?.type || '—' }}</p>
        </div>
        <div class="field mb-3">
            <label class="font-semibold">{{ 'fileSystem.folderManagement.fileSize' | translate }}</label>
            <p class="mt-2 mb-0">{{ fileDetails?.file_Size ? formatFileSize(fileDetails.file_Size) : (fileDetails?.size
                || '—') }}</p>
        </div>
        <div class="field mb-3">
            <label class="font-semibold">{{ 'fileSystem.folderManagement.lastModified' | translate }}</label>
            <p class="mt-2 mb-0">{{ fileDetails?.last_Modified || fileDetails?.last_modified || fileDetails?.modified ||
                selectedFileForDetails?.modified || '—' }}</p>
        </div>
        <div class="field mb-3" *ngIf="fileDetails?.created_At || fileDetails?.created_at">
            <label class="font-semibold">{{ 'fileSystem.folderManagement.createdAt' | translate }}</label>
            <p class="mt-2 mb-0">{{ fileDetails?.created_At || fileDetails?.created_at || '—' }}</p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideFileDetailsDialog()"></p-button>
    </ng-template>
</p-dialog>

<!-- Rename File Dialog -->
<p-dialog [header]="'fileSystem.folderManagement.renameFileDialogTitle' | translate"
    [(visible)]="renameFileDialogVisible" [modal]="true" [style]="{ width: '400px' }" (onHide)="hideRenameFileDialog()"
    [draggable]="false" [resizable]="false">
    <div class="p-fluid">
        <div class="field mb-3">
            <label for="renameFileName">{{ 'fileSystem.folderManagement.fileName' | translate }}</label>
            <input pInputText id="renameFileName" [(ngModel)]="renameFileName" class="w-full mt-2" />
        </div>
        <div class="field mb-3">
            <label for="renameFileType">{{ 'fileSystem.folderManagement.fileType' | translate }}</label>
            <input pInputText id="renameFileType" [(ngModel)]="renameFileType" class="w-full mt-2" />
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideRenameFileDialog()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.save' | translate" (onClick)="onRenameFileSave()"></p-button>
    </ng-template>
</p-dialog>

<!-- Delete File Confirmation Dialog -->
<p-dialog [header]="'fileSystem.folderManagement.deleteFileDialogTitle' | translate"
    [(visible)]="deleteFileConfirmVisible" [modal]="true" [style]="{ width: '450px' }"
    (onHide)="hideDeleteFileConfirm()" [draggable]="false" [resizable]="false">
    <div class="flex align-items-center gap-3 mb-3">
        <i class="pi pi-exclamation-triangle text-2xl text-yellow-500"></i>
        <p class="mb-0" *ngIf="selectedFileForDelete">
            {{ 'fileSystem.folderManagement.confirmDeleteFile' | translate: { name: selectedFileForDelete.name } }}
        </p>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'fileSystem.companyStorage.close' | translate" styleClass="p-button-secondary"
            (onClick)="hideDeleteFileConfirm()"></p-button>
        <p-button [label]="'fileSystem.companyStorage.delete' | translate" severity="danger"
            (onClick)="onDeleteFileConfirm()"></p-button>
    </ng-template>
</p-dialog>

<!-- Toast for messages -->
<p-toast></p-toast>

<!-- Download progress component (fixed at bottom) -->
<div *ngIf="downloadProgressVisible" class="download-progress-container">
    <div class="download-progress-card card">
        <div class="flex align-items-center gap-3 w-full">
            <i class="pi pi-download text-primary text-xl"></i>
            <div class="flex flex-column gap-2 flex-1">
                <div class="flex align-items-center justify-content-between">
                    <span class="font-semibold">
                        {{ currentDownloadingFileName }}
                    </span>
                    <button pButton type="button" icon="pi pi-times" class="p-button-rounded p-button-text p-button-sm"
                        (click)="hideDownloadProgress()" [pTooltip]="'fileSystem.folderManagement.hide' | translate">
                    </button>
                </div>
                <p-progressBar [value]="downloadProgressPercent" [showValue]="true"></p-progressBar>
                <div class="flex align-items-center justify-content-between">
                    <small class="text-500">
                        {{ downloadProgressPercent }}%
                    </small>
                    <small class="text-500" *ngIf="downloadFileSizeBytes > 0">
                        {{ 'fileSystem.folderManagement.remaining' | translate }}: {{
                        formatBytes(downloadRemainingBytes) }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>